<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title><![CDATA[Jared Forsyth]]></title>
    <link>http://jaredly.github.io/</link>
    <atom:link href="categories/javascript/rss.xml" rel="self" type="application/rss+xml"/>
    <description><![CDATA[A blog about web development, programming languages, react, etc.]]></description>
    <pubDate>2017-04-11T17:05:36.000Z</pubDate>
    <generator>http://zespia.tw/hexo/</generator>
    
    <item>
      <title><![CDATA[Detecting unused styles in JavaScript with `babel-traverse`]]></title>
      <link>http://jaredly.github.io/2017/04/08/analyzing-javascript-with-babel-traverse/</link>
      <guid>http://jaredly.github.io/2017/04/08/analyzing-javascript-with-babel-traverse/</guid>
      <pubDate>Sat, 08 Apr 2017 21:47:36 GMT</pubDate>
      <description>
      <![CDATA[It's unexpectedly easy to do powerful analysis using the tools babel provides.]]>
      
      </description>
      <content:encoded><![CDATA[<p>Last week, my coworker <a href="https://twitter.com/crm416" target="_blank" rel="external">Charlie</a> asked what it would take to automatically detect and purge unused <a href="https://github.com/Khan/aphrodite" target="_blank" rel="external">aphrodite</a> styles in our codebase.</p>
<p>If asked 2 years ago, I probably would have gone with a regex and a string-munging python script, but Iâ€™d just spent the past few nights messing with babel plugins, and figured I could probably get pretty far with relatively little work. As it happened, I was <strong>impressed by how easy it was</strong> using the tools that babel provides.</p>
<p>As a bonus, it also works with <a href="https://github.com/facebook/react-native" target="_blank" rel="external">React Native</a> because they have the same API, and it could probably be extended to other libraries without too much work.</p>
<a id="more"></a>
<h2 id="Hereâ€™s-what-weâ€™re-building"><a href="#Hereâ€™s-what-weâ€™re-building" class="headerlink" title="Hereâ€™s what weâ€™re building"></a>Hereâ€™s what weâ€™re building</h2><p>Weâ€™re making the guts of the <a href="https://github.com/jaredly/stylecleanup" target="_blank" rel="external">stylecleanup</a> tool, which finds &amp; deletes unused styles in your JavaScript, and works with both <a href="https://github.com/Khan/aphrodite" target="_blank" rel="external">aphrodite</a> and <a href="https://github.com/facebook/react-native" target="_blank" rel="external">React Native</a>.</p>
<p><a href="https://github.com/jaredly/stylecleanup" target="_blank" rel="external"><img src="https://github.com/jaredly/stylecleanup/blob/master/docs/screencap.gif?raw=true" alt="screencap of stylecleanup in action"></a></p>
<p>For example, hereâ€™s a React Native file</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123;StyleSheet, View&#125; <span class="keyword">from</span> <span class="string">'react-native'</span></div><div class="line"><span class="keyword">import</span> &#123;Component&#125; <span class="keyword">from</span> <span class="string">'react'</span></div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">MyComponent</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">  render() &#123;</div><div class="line">  	<span class="keyword">return</span> &lt;View style=&#123;styles.header&#125; /&gt;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">const styles = StyleSheet.create(&#123;</div><div class="line">  header: &#123; backgroundColor: 'red' &#125;,</div><div class="line">  awesome: &#123; fontSize: 20 &#125;,</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>The style <code>awesome</code> is unused, and weâ€™d like to automatically detect that.</p>
<h2 id="Hereâ€™s-how-we-do-it"><a href="#Hereâ€™s-how-we-do-it" class="headerlink" title="Hereâ€™s how we do it"></a>Hereâ€™s how we do it</h2><p>The rough steps are</p>
<ul>
<li>parse the JavaScript file</li>
<li>find all the stylesheet declarations, e.g. <code>const myStyleSheet = StyleSheet.create({ .... })</code></li>
<li>get a list of the styles within that stylesheet (e.g. <code>&quot;header&quot;</code>, <code>&quot;awesome&quot;</code>)</li>
<li>go through and find references to that stylesheet, e.g. <code>myStyleSheet.someStyle</code></li>
<li>from that, determine which styles are never referenced and can be safely deleted</li>
</ul>
<h3 id="Parse-the-JavaScript-file"><a href="#Parse-the-JavaScript-file" class="headerlink" title="Parse the JavaScript file"></a>Parse the JavaScript file</h3><p>Weâ€™ll be using the libraries <a href="">babylon</a> and <a href="">babel-traverse</a>. The <a href="https://github.com/thejameskyle/babel-handbook/blob/master/translations/en/plugin-handbook.md" target="_blank" rel="external">plugins section</a> of <a href="https://twitter.com/thejameskyle" target="_blank" rel="external">@thejameskyle</a>â€˜s <a href="https://github.com/thejameskyle/babel-handbook" target="_blank" rel="external">babel-handbook</a> is also an excellent reference.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> babylon = <span class="built_in">require</span>(<span class="string">'babylon'</span>)</div><div class="line"><span class="keyword">const</span> text = fs.readFileSync(file, <span class="string">'utf8'</span>)</div><div class="line"><span class="keyword">const</span> ast = babylon.parse(text, &#123;</div><div class="line">  <span class="comment">// this means that `import` and `export` are allowed</span></div><div class="line">  sourceType: <span class="string">'module'</span>,</div><div class="line">  <span class="comment">// we want to allow all the fancy syntax</span></div><div class="line">  plugins: [<span class="string">'jsx'</span>, <span class="string">'flow'</span>, <span class="string">'objectRestSpread'</span>, <span class="string">'classProperties'</span>],</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h3 id="Find-the-StyleSheet-declarations"><a href="#Find-the-StyleSheet-declarations" class="headerlink" title="Find the StyleSheet declarations"></a>Find the StyleSheet declarations</h3><p>Weâ€™ll look for the form <code>const myStyleSheet = StyleSheet.create({ .... })</code></p>
<p>Weâ€™re going to use <a href="https://github.com/babel/babel/tree/master/packages/babel-traverse" target="_blank" rel="external"><code>babel-traverse</code></a>, which makes walking through the tree super easy.</p>
<p>It gives us a function, <code>traverse</code>, that will walk through the whole AST, and call the visitors we specify corresponding to the type of a given node. To figure out what the types are (and what the shape of the AST is like), I lean on <a href="https://astexplorer.net/" target="_blank" rel="external">astexplorer.net</a> and <a href="https://github.com/babel/babel/blob/master/packages/babel-types/README.md" target="_blank" rel="external">the Readme</a> of <a href="https://github.com/babel/babel/tree/master/packages/babel-types" target="_blank" rel="external">babel-types</a>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> styleSheets = []</div><div class="line">traverse(ast, &#123;</div><div class="line">  CallExpression(path) &#123;</div><div class="line">    <span class="keyword">if</span> (isStyleSheetCreate(path)) &#123;</div><div class="line">      <span class="keyword">const</span> members = path.node.arguments[<span class="number">0</span>].properties.filter(</div><div class="line">        <span class="comment">// Not gonna try to figure out spreads</span></div><div class="line">        property =&gt; property.type === <span class="string">'ObjectProperty'</span></div><div class="line">      )</div><div class="line">      <span class="keyword">const</span> styleNames = members.map(<span class="function"><span class="params">member</span> =&gt;</span> member.key.name)</div><div class="line">      styleSheets.push(&#123;<span class="attr">id</span>: path.parent.id, styleNames&#125;)</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>So I go through every <a href="https://github.com/babel/babel/blob/master/packages/babel-types/README.md#callexpression" target="_blank" rel="external"><code>CallExpression</code></a>, which has the form <code>something(arg1, arg2, ...)</code>, check if it looks like <code>StyleSheet.create</code>, and then process it. The function <code>isStyleSheetCreate</code> (that Iâ€™ll describe in a second) determines whether the current node looks like <code>var myStyleSheet = StyleSheet.create({y: ... })</code>. I then grab all the members of the object thatâ€™s being passed to <code>StyleSheet.create</code>, discarding any that happen to be <a href="https://github.com/babel/babel/blob/master/packages/babel-types/README.md#objectmethod" target="_blank" rel="external"><code>ObjectMethod</code></a>s or <a href="https://github.com/babel/babel/blob/master/packages/babel-types/README.md#objectproperty" target="_blank" rel="external"><code>computed</code></a> properties, and get the names that theyâ€™re being identified by. In our example file, <code>styleNames</code> would end up being <code>[&quot;header&quot;, &quot;awesome&quot;]</code>.</p>
<p><code>path.parent.id</code> refers to the variable name that this stylesheet is being bound to â€“ <code>myStyleSheet</code> in the <code>var myStyleSheet = StyleSheet.create({y: ...})</code> example.</p>
<p>So at the end of this I have a list of the stylesheets that got created and assigned to a variable, and the style names within each stylesheet.</p>
<h4 id="Letâ€™s-look-at-isStyleSheetCreate-now"><a href="#Letâ€™s-look-at-isStyleSheetCreate-now" class="headerlink" title="Letâ€™s look at isStyleSheetCreate now."></a>Letâ€™s look at <code>isStyleSheetCreate</code> now.</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> isStyleSheetCreate = <span class="function">(<span class="params">&#123;node, parent&#125;</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">return</span> node.callee.type === <span class="string">'MemberExpression'</span> &amp;&amp;</div><div class="line">    node.callee.object.type === <span class="string">'Identifier'</span> &amp;&amp;</div><div class="line">    node.callee.object.name === <span class="string">'StyleSheet'</span> &amp;&amp;</div><div class="line">    node.callee.property.name === <span class="string">'create'</span> &amp;&amp;</div><div class="line">    parent.type === <span class="string">'VariableDeclarator'</span> &amp;&amp;</div><div class="line">    node.arguments.length === <span class="number">1</span> &amp;&amp;</div><div class="line">    node.arguments[<span class="number">0</span>].type === <span class="string">'ObjectExpression'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The argument Iâ€™m passing in is a <a href="https://github.com/babel/babel/blob/master/packages/babel-traverse/src/path/index.js#L14" target="_blank" rel="external"><code>NodePath</code></a> that has many attributes, but the ones we care about are <code>node</code> and <code>parent</code>, which are both nodes in our AST (again, refer to the <a href="https://github.com/babel/babel/blob/master/packages/babel-types/README.md" target="_blank" rel="external">babel-types Readme</a> for more info).</p>
<p>These checks establish that</p>
<ul>
<li>The function being called is <code>StyleSheet.create</code></li>
<li>Itâ€™s only being called with one argument, which is an object literal</li>
<li>Itâ€™s being assigned to a variable (indicated by the parent being a <a href="https://github.com/babel/babel/blob/master/packages/babel-types/README.md#variabledeclarator" target="_blank" rel="external"><code>VariableDeclarator</code></a></li>
</ul>
<h3 id="Find-all-the-references-to-styles"><a href="#Find-all-the-references-to-styles" class="headerlink" title="Find all the references to styles"></a>Find all the references to styles</h3><p>as in <code>myStyleSheet.someStyle</code></p>
<p><code>babel-traverse</code> actually makes this super easy for us, because it <strong>already tracks all variable references</strong>. We can just hang on to the <a href="https://github.com/babel/babel/blob/master/packages/babel-traverse/src/scope/binding.js#L14" target="_blank" rel="external"><code>Binding</code></a> object that it uses to collect references, and then iterate through them after traversal.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> styleSheets = []</div><div class="line">traverse(ast, &#123;</div><div class="line">  CallExpression(path) &#123;</div><div class="line">    <span class="keyword">if</span> (isStyleSheetCreate(path)) &#123;</div><div class="line">      <span class="keyword">const</span> members = path.node.arguments[<span class="number">0</span>].properties.filter(</div><div class="line">        <span class="function"><span class="params">property</span> =&gt;</span> property.type === <span class="string">'ObjectProperty'</span> <span class="comment">// Not gonna try to figure out spreads</span></div><div class="line">      )</div><div class="line">      <span class="keyword">const</span> styleNames = members.map(<span class="function"><span class="params">member</span> =&gt;</span> member.key.name)</div><div class="line">      styleSheets.push(&#123;</div><div class="line">        <span class="attr">id</span>: path.parent.id,</div><div class="line">        styleNames,</div><div class="line">        <span class="comment">// hang on to the binding object for "myStyleSheet"</span></div><div class="line">        binding: path.scope.getBinding(path.parent.id.name)</div><div class="line">      &#125;)</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>Now we iterate through our stylesheets, and take a look at the references.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">styleSheets.forEach(<span class="function">(<span class="params">&#123;id, styleNames, binding&#125;</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">const</span> referencedNames = binding.referencePaths</div><div class="line">    .filter(<span class="function"><span class="params">ref</span> =&gt;</span> ref.parent.type === <span class="string">'MemberExpression'</span> &amp;&amp; !ref.parent.computed)</div><div class="line">    .map(<span class="function"><span class="params">ref</span> =&gt;</span> ref.parent.property.name)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>In the example reference <code>&lt;View style={styles.header} /&gt;</code>, the <code>referencePath</code> just points to the <code>styles</code> identifier, which is the reference to our stylesheet binding. We want to get the string <code>&quot;header&quot;</code>, so we</p>
<ul>
<li>determine that weâ€™re looking at a <a href="https://github.com/babel/babel/blob/master/packages/babel-types/readme.md#memberexpression" target="_blank" rel="external"><code>MemberExpression</code></a> (e.g. <code>styles.something</code>)</li>
<li>make sure itâ€™s not computed (we canâ€™t do much with <code>styles[someVariable]</code>)</li>
<li>get the property name (e.g. <code>&quot;header&quot;</code>)</li>
</ul>
<h3 id="Then-use-the-list-of-references-to-determine-which-styles-arenâ€™t-being-used-at-all"><a href="#Then-use-the-list-of-references-to-determine-which-styles-arenâ€™t-being-used-at-all" class="headerlink" title="Then use the list of references to determine which styles arenâ€™t being used at all."></a>Then use the list of references to determine which styles arenâ€™t being used at all.</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">styleSheets.forEach(<span class="function">(<span class="params">&#123;id, styleNames, binding&#125;</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">const</span> referencedNames = binding.referencePaths</div><div class="line">    .filter(<span class="function"><span class="params">ref</span> =&gt;</span> ref.parent.type === <span class="string">'MemberExpression'</span> &amp;&amp; !ref.parent.computed)</div><div class="line">    .map(<span class="function"><span class="params">ref</span> =&gt;</span> ref.parent.property.name)</div><div class="line">  <span class="keyword">const</span> unused = styleNames.filter(<span class="function"><span class="params">name</span> =&gt;</span> referencedNames.indexOf(name) === <span class="number">-1</span>)</div><div class="line">  <span class="comment">// ðŸŽ‰</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>Just for kicks, we can also get a list of styles that are referenced, but never defined!</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">styleSheets.forEach(<span class="function">(<span class="params">&#123;id, styleNames, binding&#125;</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">const</span> referencedNames = binding.referencePaths</div><div class="line">    .filter(<span class="function"><span class="params">ref</span> =&gt;</span> ref.parent.type === <span class="string">'MemberExpression'</span> &amp;&amp; !ref.parent.computed)</div><div class="line">    .map(<span class="function"><span class="params">ref</span> =&gt;</span> ref.parent.property.name)</div><div class="line">  <span class="keyword">const</span> unused = styleNames.filter(<span class="function"><span class="params">name</span> =&gt;</span> referencedNames.indexOf(name) === <span class="number">-1</span>)</div><div class="line">  <span class="comment">// too easy</span></div><div class="line">  <span class="keyword">const</span> missing = referencedNames.filter(<span class="function"><span class="params">name</span> =&gt;</span> styleNames.indexOf(name) === <span class="number">-1</span>)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h2 id="And-weâ€™re-done"><a href="#And-weâ€™re-done" class="headerlink" title="And weâ€™re done!"></a>And weâ€™re done!</h2><p>To see the code in context, look at <a href="https://github.com/jaredly/stylecleanup/blob/master/analyzeFile.js" target="_blank" rel="external"><code>analyzeFile.js</code></a> in the <a href="https://github.com/jaredly/stylecleanup" target="_blank" rel="external"><code>stylecleanup</code></a> project.</p>
<p>For a real tool, thereâ€™s some more bookkeeping involved in</p>
<ul>
<li>showing the lines of code where e.g. a missing style is referenced</li>
<li>being conservative about what styles are definitely unused vs styles that <em>might</em> be unused â€“ if the stylesheet variable is used in a way that we ignore (e.g. not in a <a href="https://github.com/babel/babel/blob/master/packages/babel-types/README.md#memberexpression" target="_blank" rel="external"><code>MemberExpression</code></a>, or with a computed lookup), then there could be references to styles that we canâ€™t track.</li>
</ul>
]]></content:encoded>
      <comments>http://jaredly.github.io/2017/04/08/analyzing-javascript-with-babel-traverse/#disqus_comments</comments>
    </item>
    
  </channel>
</rss>
