<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf8"/>
<meta name="description" content="A deep dive on hybrid logical clocks - how to determine the 'true' ordering of events in a distributed system"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="HandheldFriendly" content="True"/>
<meta name="MobileOptimized" content="320"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Hybrid Logical Clocks | Jared Forsyth.com"/>
<meta name="twitter:description" content="A deep dive on hybrid logical clocks - how to determine the 'true' ordering of events in a distributed system"/>
<meta name="twitter:image" content="https://jaredforsyth.com/images/logo/JF_black_128.png"/>
<meta name="twitter:site" content="https://jaredforsyth.com"/>
<meta name="twitter:creator" content="@jaredforsyth"/>
<meta property="og:type" content="article"/>
<meta property="og:title" content="Hybrid Logical Clocks | Jared Forsyth.com"/>
<meta property="og:description" content="A deep dive on hybrid logical clocks - how to determine the 'true' ordering of events in a distributed system"/>
<link rel="shortcut icon" href="/images/logo/JF_black_32.png"></link>
<title>
 
Hybrid Logical Clocks | Jared Forsyth.com
 
</title>
<link rel="stylesheet" href="//brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Merriweather:200,200i,400,400i,700,700i/Open+Sans:400,400i,700,700i"></link>
<link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel="stylesheet"></link>
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-one-light.min.css" rel="stylesheet" media="not (prefers-color-scheme: dark)"></link>
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-vsc-dark-plus.min.css" rel="stylesheet" media="(prefers-color-scheme: dark)"></link>
<script>
if (localStorage.viewMode) {
                    document.getElementsByTagName('html')[0].className = localStorage.viewMode;
                }
                window.addEventListener('load', () => {
                    const node = document.createElement('div');
                    const dark = document.createElement('a');
                    const light = document.createElement('a');
                    dark.className = 'dark-mode-button';
                    light.className = 'light-mode-button';

                    window.setMode = (mode) => {
                        if (localStorage.viewMode === mode) {
                            localStorage.viewMode = ''
                            document.getElementsByTagName('html')[0].className = 'mode-change'

                        } else {
                            localStorage.viewMode = mode
                            document.getElementsByTagName('html')[0].className = localStorage.viewMode + ' mode-change';
                        }
                    }
                    dark.onclick = (evt) => {
                        setMode('dark-mode');
                        evt.preventDefault()
                    }
                    light.onclick = (evt) => {
                        setMode('light-mode');
                        evt.preventDefault()
                    }

                    dark.textContent = 'dark mode';
                    dark.href = 'javascript:setMode("dark-mode")'
                    light.textContent = 'light mode';
                    light.href = 'javascript:setMode("light-mode")'
                    node.appendChild(dark)
                    node.appendChild(document.createTextNode(' ¬∑ '));
                    node.appendChild(light)
                    Object.assign(node.style, {
                        position: 'absolute',
                        top: '8px',
                        right: '8px',
                    });
                    document.body.appendChild(node);
                })
                
</script>
<style>

    html.mode-change {
        transition: background-color .1s ease;
    }
    html.light-mode, :root {
        
        --color-text: #333;
        --color-lightText: #999;
        --color-red: #692900;
        --color-lightOrange: #fff4ef;
        --color-darkGreen: #147429;
        --color-green: #1fad3e;
        --color-code: #ffede4;
        --color-codeText: #692900;
        background-color: white;
    
    }

    @media (prefers-color-scheme: dark) {
        :root {
            
        --color-text: #ccc;
        --color-lightText: #999;
        --color-red: #1dd442;
        --color-lightOrange: #0f0d0d;
        --color-darkGreen: #d8ac7e;
        --color-green: #ef8d27;
        --color-code: #361402;
        --color-codeText: #f9d6bf;
        background-color: #21262c;
    
        }
    }

    html.dark-mode {
        
        --color-text: #ccc;
        --color-lightText: #999;
        --color-red: #1dd442;
        --color-lightOrange: #0f0d0d;
        --color-darkGreen: #d8ac7e;
        --color-green: #ef8d27;
        --color-code: #361402;
        --color-codeText: #f9d6bf;
        background-color: #21262c;
    
    }

    main a:not([href^="/"]):not([href^="#"]):after {
        color: red;
        content: 'üåê';
        font-size: 70%;
        margin-left: 4px;
    }

    .dark-mode-button, .light-mode-button {
        text-decoration: none;
        color: var(--color-text);
    }

    html.dark-mode .dark-mode-button,
    html.light-mode .light-mode-button {
        text-decoration: underline;
        color: var(--color-green);
    }

    code[class*=language-], pre[class*=language-] {
        font-size: 90% !important;
    }

    #comments p {
        font-size: 90%;
    }
    #comments p:last-child {
        padding-bottom: 0;
    }
    #hn p {
        font-size: 60%;
        line-height: 1.8em;
    }
    #hn p:last-child {
        padding-bottom: 0;
    }

      div {
        flex-shrink: 0;
        flex-wrap: wrap;
        box-sizing: border-box;
        min-height: 0;
        min-width: 0;
      }
      span {
        box-sizing: border-box;
      }
      code[class*=language-], pre[class*=language-],
      pre {
        margin: 0;
        margin-bottom: 1.5em;
      }
      pre {
        line-height: 18px;
        font-size: 16px;
        /* white-space: pre-wrap; */
        overflow: auto;
        max-width: 100%;
        padding: 15px;
        /* border: 1px solid #ddd; */
        font-family: Inconsolata;
        background-color: var(--color-code);
        color: var(--color-codeText);
        border-radius: 4px;
      }
      img {
        max-width: 100%;
      }
      li > code,
      a > code,
      p > code {
        font-size: 90%;
        padding: 4px;
        background-color: var(--color-code);
        color: var(--color-codeText);
        border-radius: 4px;
        hyphens: none;
      }
      blockquote {
          margin: 0;
          margin-bottom: 1em;
          padding-left: 20px;
          border-left: 5px solid var(--color-green);
          font-style: italic;
      }
      blockquote.twitter-tweet {
        font-style: normal;
        border: 1px solid var(--color-green);
        border-radius: 4px;
        padding: 8px 16px;
        font-size: 20px;
      }
      div.note {
        font-style: italic;
        flex-wrap: nowrap;
        display: flex;
        align-items: flex-start;
        font-size: 90%;
      }
      div.note::before {
        margin-right: 8px;
        content: 'i';
        border: 1px solid #ccc;
        padding: 2px 10px;
        border-radius: 50px;
        font-family: arial;
        font-style: normal;
        font-size: 20px;
        display: inline;
        line-height: 1;
        margin-top: 5px;
      }
      a {
        color: var(--color-green);
        text-decoration: none;
        /* color: #28cc4c;
        text-decoration-color: #28cc4c; */
      }
      a:hover {
        text-decoration: underline;
      }
      h1 > a, h2 > a, h3 > a, h4 > a, h5 > a, h6 > a {
        text-decoration: none;
        color: inherit;
      }
      h1 > a:hover, h2 > a:hover, h3 > a:hover, h4 > a:hover, h5 > a:hover, h6 > a:hover,
      h1 > a:focus, h2 > a:focus, h3 > a:focus, h4 > a:focus, h5 > a:focus, h6 > a:focus {
        text-decoration: underline;
        color: var(--color-green);
      }
      ul, ol {
        margin-top: 0;
      }
      .post-body h1 {
        font-family: Open sans;
      }
      h2 {
        padding-bottom: 16px;
        font-size: 32px;
        margin: 0;
        margin-top: 1em;
      }
      p {
        margin: 0;
        padding-bottom: 1em;
      }
      blockquote > p:last-child {
        padding-bottom: 0;
      }
      h3 {
        margin-bottom: 8px;
        font-family: Open sans;
        font-weight: normal;
        margin-top: 8px;
        color: #6e6e6e;
        font-size: 30px;
      }
      h5 {
        font-family: open sans;
        margin: 0;
        margin-top: 16px;
      }
      /* a:visited {
        color: #333;
      } */
      
</style>
<style>
 
.style-bb1ef180179301565afe9016b11ab16ed7413965 {
  padding: 0 16px;
  flex-shrink: 1;
  overflow: auto;
}
.style-6ae0154d10d8b0dbf4c75fa5adb959a39f9a7739 {
  text-decoration: none;
  color: inherit;
}
.style-6ae0154d10d8b0dbf4c75fa5adb959a39f9a7739:hover {
  text-decoration: underline;
}
.style-989db2448f309bfdd99b513f37c84b8f5794d2b5 {

}
.style-0044f7a33153e82f3678591650843ffdc0f020fe {
  font-size: 16px;
  margin-bottom: 16px;
  display: block;
  line-height: 20px;
  color: currentColor;
  text-decoration: none;
}
.style-0044f7a33153e82f3678591650843ffdc0f020fe:hover {
  text-decoration: underline;
}
.style-600fca2a90c30e17c2a20ea4f2f653cf60098d5b {
  color: var(--color-lightText);
  display: flex;
  flex-direction: row;
}
.style-92b92032b41d8e558573c6926aeaeeb3456b873e {
  margin-top: 100px;
  font-size: 56px;
  margin-bottom: 16px;
  padding-top: 32px;
}
@media(max-width: 600px) {
.style-92b92032b41d8e558573c6926aeaeeb3456b873e {
  font-size: 32px;
  margin-top: 40px;
}
}
@media(max-width: 600px) {
.style-92b92032b41d8e558573c6926aeaeeb3456b873e {
  margin-top: 40px;
}
}
.style-d9a01dccc38720dfd616bfebd6cb0499248e200b {
  color: var(--color-lightText);
  font-family: Open sans;
  font-size: 14px;
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: flex-start;
}
.style-fde29ab0420a52958e612784d49ff404f48528ae {
  text-decoration: none;
}
.style-cda9f9781eb5258ad50a00716278a6233b0a6313 {
  font-size: 22px;
  line-height: 40px;
  hyphens: auto;
  font-family: Merriweather;
  font-weight: 200;
}
@media(max-width: 600px) {
.style-cda9f9781eb5258ad50a00716278a6233b0a6313 {
  font-size: 20px;
  line-height: 30px;
}
}
.style-cd92fd8450a8c6641a2f0f2f0daac33e94b99b35 {
  font-family: Linux Libertine;
  color: var(--color-text);
  margin: 0;
  padding: 0;
}
.style-dc1f12ded94275ec46fa7abd837a78fd6347d5e4 {
  position: fixed;
  top: 10px;
  left: 10px;
  padding: 8px;
  background-color: black;
}
@media(min-width: 1061px) {
.style-dc1f12ded94275ec46fa7abd837a78fd6347d5e4 {
  display: none;
}
}
.style-f2140e5d177bae23c12d832734b5ce5fb0b21aa9 {
  height: 32px;
  width: 32px;
  background-size: cover;
}
.style-0da148fa6be0269fa24b9fd57a9a57aeb5297d0d {
  flex-direction: row;
  padding: 0 20px;
  display: flex;
  justify-content: center;
  align-items: stretch;
  flex-wrap: wrap;
  justify-content: flex-start;
  flex-wrap: nowrap;
}
@media(max-width: 1060px) {
.style-0da148fa6be0269fa24b9fd57a9a57aeb5297d0d {
  justify-content: center;
}
}
@media(max-width: 835px) {
.style-0da148fa6be0269fa24b9fd57a9a57aeb5297d0d {
  padding: 8px;
}
}
.style-9dc27aab0a26df3e65720efcd4de1d4b5e9e64f8 {
  background-color: var(--color-lightOrange);
  max-width: 400px;
  flex-shrink: 1;
  min-width: 300px;
  padding: 40px;
}
@media(max-width: 835px) {
.style-9dc27aab0a26df3e65720efcd4de1d4b5e9e64f8 {
  padding: 16px;
}
}
@media(max-width: 1650px) {
.style-9dc27aab0a26df3e65720efcd4de1d4b5e9e64f8 {
  padding: 20px;
}
}
@media(max-width: 1060px) {
.style-9dc27aab0a26df3e65720efcd4de1d4b5e9e64f8 {
  display: none;
}
}
.style-070d16e7de42659938f24594f2b149329d23dc29 {
  top: 40px;
}
@media(max-width: 835px) {
.style-070d16e7de42659938f24594f2b149329d23dc29 {
  top: 16px;
}
}
@media(max-width: 1650px) {
.style-070d16e7de42659938f24594f2b149329d23dc29 {
  top: 20px;
}
}
@media(min-width: 835px) {
.style-070d16e7de42659938f24594f2b149329d23dc29 {
  position: sticky;
  height: calc(100vh - 80px);
  display: flex;
  flex-wrap: nowrap;
  flex-direction: column;
}
}
.style-3ba81e27d2f8c377a36c12c6516f97660ec3facb {
  margin: 0 auto;
  width: 160px;
  overflow: hidden;
  height: 160px;
  display: block;
  border-radius: 50%;
  border: 5px solid white;
  background-color: white;
  box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3);
}
.style-1acf1679204e721558d0d3292da71a07307421a4 {
  display: block;
  width: 160px;
  height: 160px;
}
.style-0038018cf11394bd2f3cad50b7fc1d34d431f8b0 {
  text-align: center;
  font-size: 36px;
}
.style-683404bf430036582caafb930681970b717e3e38 {
  font-size: 24px;
  line-height: 36px;
  flex: 1;
  display: flex;
  flex-direction: column;
  flex-wrap: nowrap;
  text-align: left;
}
.style-da667265deef9362aecb588a818eaba3fef53068 {
  margin-bottom: 40px;
  justify-content: center;
  display: flex;
  flex-direction: row;
}
.style-da667265deef9362aecb588a818eaba3fef53068 a {
  margin: 0 8px;
}
.style-74e366023ce61639103d5fb83af3a27e33357285 {
  font-family: Open sans, sans-serif;
  font-size: 20px;
}
.style-74e366023ce61639103d5fb83af3a27e33357285 a {
  text-decoration: none;
}
.style-74e366023ce61639103d5fb83af3a27e33357285 a:hover {
  text-decoration: underline;
}
.style-ce615c601d9c9081e34880573a9c0d6582fa6737 {

}
@media(max-width: 1060px) {
.style-ce615c601d9c9081e34880573a9c0d6582fa6737 {
  display: none;
}
}
.style-cea2d442503956980c7eeb14acb78a14064ee9d4 {
  max-width: 700px;
}
@media(max-width: 1060px) {
.style-cea2d442503956980c7eeb14acb78a14064ee9d4 {
  flex-shrink: 1;
  min-width: 0;
}
}
 
</style>

                
</head>
<body class="style-cd92fd8450a8c6641a2f0f2f0daac33e94b99b35" lang="en">
<a href="/" class="style-dc1f12ded94275ec46fa7abd837a78fd6347d5e4"><div class="style-f2140e5d177bae23c12d832734b5ce5fb0b21aa9" style="background-image: url(/images/logo/JF_64.png)"></div></a>
<div class="style-0da148fa6be0269fa24b9fd57a9a57aeb5297d0d">
<div class="style-9dc27aab0a26df3e65720efcd4de1d4b5e9e64f8">
<div class="style-070d16e7de42659938f24594f2b149329d23dc29">
<a href="/" class="style-3ba81e27d2f8c377a36c12c6516f97660ec3facb"><img src="https://www.gravatar.com/avatar/313878fc8f316fc3fe4443b13913d0a4.png?s=200" alt="Jared Forsyth" class="style-1acf1679204e721558d0d3292da71a07307421a4"/></a>
<div style="height: 40px"></div>
<div class="style-0038018cf11394bd2f3cad50b7fc1d34d431f8b0">I'm Jared Forsyth</div>
<div style="height: 40px"></div>
<div class="style-683404bf430036582caafb930681970b717e3e38">
<div class="style-da667265deef9362aecb588a818eaba3fef53068">
<a href="/">home</a>
<a href="/posts/">posts</a>
<a href="/projects/">projects</a>
<a href="/talks/">talks</a>
</div>
<div class="style-bb1ef180179301565afe9016b11ab16ed7413965">
<a href="/posts/" class="style-6ae0154d10d8b0dbf4c75fa5adb959a39f9a7739"><div class="style-989db2448f309bfdd99b513f37c84b8f5794d2b5">Latest posts</div></a>
<div style="height: 8px"></div>
<a href="/posts/type-inference-that-sticks/" class="style-0044f7a33153e82f3678591650843ffdc0f020fe">
<div>
 
Type inference that sticks
 
</div>
<div class="style-600fca2a90c30e17c2a20ea4f2f653cf60098d5b">
2023
February
4
</div>
</a>
<a href="/posts/whats-cool-about-unison/" class="style-0044f7a33153e82f3678591650843ffdc0f020fe">
<div>
 
What's cool about Unison?
 
</div>
<div class="style-600fca2a90c30e17c2a20ea4f2f653cf60098d5b">
2021
March
2
</div>
</a>
<a href="/posts/local-first-database-hypermerge/" class="style-0044f7a33153e82f3678591650843ffdc0f020fe">
<div>
 
Local-first database: Hypermerge
 
</div>
<div class="style-600fca2a90c30e17c2a20ea4f2f653cf60098d5b">
2020
September
30
</div>
</a>
<a href="/posts/local-first-database-rxdb-pouchdb/" class="style-0044f7a33153e82f3678591650843ffdc0f020fe">
<div>
 
Local-first database: RxDB + PouchDB
 
</div>
<div class="style-600fca2a90c30e17c2a20ea4f2f653cf60098d5b">
2020
May
12
</div>
</a>
<a href="/posts/local-first-database-remotestorage/" class="style-0044f7a33153e82f3678591650843ffdc0f020fe">
<div>
 
Local-first database: remoteStorage.js
 
</div>
<div class="style-600fca2a90c30e17c2a20ea4f2f653cf60098d5b">
2020
May
6
</div>
</a>
<div style="height: 32px"></div>
</div>
<div style="text-align:center" class="style-74e366023ce61639103d5fb83af3a27e33357285">
<a href="https://twitter.com/jaredforsyth">twitter/@jaredforsyth</a>
<br/>
<a href="https://mastodon.social/@jaredly">@jaredly@mastodon.social</a>
<br/>
<a href="https://github.com/jaredly">github/@jaredly</a>
<br/>
<a href="/posts/rss.xml">posts rss feed</a>
</div>
</div>
</div>
</div>
<div style="flex-basis: 100px; flex-shrink: 1" class="style-ce615c601d9c9081e34880573a9c0d6582fa6737"></div>
<div class="style-cea2d442503956980c7eeb14acb78a14064ee9d4">
<main role="main">
<article>
 
<h1 class="style-92b92032b41d8e558573c6926aeaeeb3456b873e">Hybrid Logical Clocks</h1>
<div class="style-d9a01dccc38720dfd616bfebd6cb0499248e200b">
February
<div style="flex-basis: 4px"></div>
14,
<div style="flex-basis: 4px"></div>
2020
<div style="flex-basis: 8px"></div>
 ¬∑ 
<div style="flex-basis: 8px"></div>
<a href="/tags/local-first/" class="style-fde29ab0420a52958e612784d49ff404f48528ae">local-first</a>
<div style="flex-basis: 8px"></div>

</div>
<div style="height: 32px"></div>
<div class="post-body style-cda9f9781eb5258ad50a00716278a6233b0a6313">
<div class='note'><p>This is the first in a series of posts digging into James Long‚Äôs talk <a href="https://www.dotconferences.com/2019/12/james-long-crdts-for-mortals">CRDTs for Mortals</a>, and the accompanying <a href="https://github.com/jlongster/crdt-example-app">demo app</a> he created.</p>
</div>
<p>So, you‚Äôre writing a <s>destributed system</s> local-first app, and you‚Äôre sending events back and forth between various clients and the server. One thing you‚Äôd really like to be able to do is determine <strong>the order in which events happened</strong> ‚Äì this is important for the ‚Äúlast‚Äù part of ‚Äúlast-write-wins‚Äù CRDTs, for example. So you add a timestamp to each event as it‚Äôs created, and all is well.</p>

<!-- more -->
<p>Until someone points out to you that the source you‚Äôre using for a timestamp ‚Äì the local machine‚Äôs ‚Äúwall clock‚Äù ‚Äì isn‚Äôt completely reliable. Clocks drift, sometimes they go backward, and a malicious or particularly incompetent user could set their device‚Äôs clock to a wildly inaccurate value. For example, if one client‚Äôs clock is a day ahead, and they send some changes to an object, other clients would be completely unable to make changes to that object until the following day, when their local timestamps finally become ‚Äúlater‚Äù than the bad-actor‚Äôs timestamps.</p>

<p>Now there are decent odds you could get away with just using timestamps, if your requirements for overall correctness are not too strict. Computers and phones tend to auto-update their clocks fairly frequently, and bad actors are likely to be rare. On the other hand, if it‚Äôs easy to fix, why do the thing that‚Äôs worse?</p>

<p>Fortunately, there‚Äôs a tight little algorithm that does a pretty good approximation of telling you ‚Äúthe order in which events happened‚Äù in a distributed system: the <a href="https://muratbuffalo.blogspot.com/2014/07/hybrid-logical-clocks.html">Hybrid Logical Clock (HLC)</a>.</p>

<p>Let‚Äôs be clear up-front about the promises this clock is making; it cannot divine the actual real-life ordering of all events. It does however make the following guarantees:</p>

<ol><li><div><p>All events created on a single machine will be correctly ordered with respect to each other (even if the wall clock jumps back a second or is otherwise squirrely).</p>
</div></li>
<li><div><p>Once machine A sends events to machine B, all events subsequently created on machine B will be ordered as <em>after</em> those events from machine A. So if A sets their clock one day ahead, makes some changes, and sends them to B, B will still be able to make changes even though its own wall clock is ‚Äòbehind‚Äô.</p>
</div></li></ol>
<h1 id="HLC-Implementation" tabindex="-1"><a class="header-anchor" href="#HLC-Implementation">HLC Implementation</a></h1>

<p>The HLC algorithm is simple enough that we can walk through the whole thing right here. If you want to see it all together, <a href="https://github.com/jaredly/hybrid-logical-clocks-example/blob/master/src/hlc.js">here‚Äôs the full source</a>.</p>

<p>The Hybric Logical Clock consists of two elements ‚Äì a timestamp (ts) and a counter (count).</p>

<pre><code><span class="token keyword">export</span> <span class="token keyword">const</span> init <span class="token operator">=</span> <span class="token punctuation">(</span>node<span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">now</span><span class="token operator">:</span> number<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token constant">HLC</span></span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">ts</span><span class="token operator">:</span> now<span class="token punctuation">,</span>
    <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    node<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<div class='note'><p>In practice, you‚Äôll want a third element, a ‚Äúnode ID‚Äù that is unique per device, that you can use to break ties if the timestamp and counter are, by some incredible fluke, exactly the same between events generated on two devices.</p>
</div>
<p>The clock is initialized with <code class="language-javascript">ts</code> as the device‚Äôs wall clock timestamp, and <code class="language-javascript">count</code> at 0.</p>

<h2 id="Inc" tabindex="-1"><a class="header-anchor" href="#Inc">Inc</a></h2>

<p>When an event occurs, you call <code class="language-javascript">inc</code> on the HLC to get an updated version to attach to that event. This function gives us guarantee #1.</p>

<pre><code><span class="token keyword">export</span> <span class="token keyword">const</span> inc <span class="token operator">=</span> <span class="token punctuation">(</span>local<span class="token operator">:</span> <span class="token constant">HLC</span><span class="token punctuation">,</span> <span class="token literal-property property">now</span><span class="token operator">:</span> number<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token constant">HLC</span></span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">></span> local<span class="token punctuation">.</span>ts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">ts</span><span class="token operator">:</span> now<span class="token punctuation">,</span> <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">node</span><span class="token operator">:</span> local<span class="token punctuation">.</span>node <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>local<span class="token punctuation">,</span> <span class="token literal-property property">count</span><span class="token operator">:</span> local<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>If the wall clock is later than the HLC‚Äôs timestamp, then we can just return a new HLC with the wall clock timestamp and a <code class="language-javascript">count</code> of <code class="language-javascript"><span class="token number">0</span></code>. If however the wall clock‚Äôs timestamp is <em>not</em> later than the HLC‚Äôs (e.g. because our wall clock jumped back), then we re-use the HLC‚Äôs timestamp, and increment the counter.</p>

<h2 id="Recv" tabindex="-1"><a class="header-anchor" href="#Recv">Recv</a></h2>

<p>When receiving events from another node, we‚Äôll need to update our HLC using the HLC from that other node. This function gives us guarantee #2.</p>

<pre><code><span class="token keyword">export</span> <span class="token keyword">const</span> recv <span class="token operator">=</span> <span class="token punctuation">(</span>local<span class="token operator">:</span> <span class="token constant">HLC</span><span class="token punctuation">,</span> <span class="token literal-property property">remote</span><span class="token operator">:</span> <span class="token constant">HLC</span><span class="token punctuation">,</span> <span class="token literal-property property">now</span><span class="token operator">:</span> number<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token constant">HLC</span></span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">></span> local<span class="token punctuation">.</span>ts <span class="token operator">&amp;&amp;</span> now <span class="token operator">></span> remote<span class="token punctuation">.</span>ts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>local<span class="token punctuation">,</span> <span class="token literal-property property">ts</span><span class="token operator">:</span> now<span class="token punctuation">,</span> <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>local<span class="token punctuation">.</span>ts <span class="token operator">===</span> remote<span class="token punctuation">.</span>ts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>local<span class="token punctuation">,</span> <span class="token literal-property property">count</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>local<span class="token punctuation">.</span>count<span class="token punctuation">,</span> remote<span class="token punctuation">.</span>count<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>local<span class="token punctuation">.</span>ts <span class="token operator">></span> remote<span class="token punctuation">.</span>ts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>local<span class="token punctuation">,</span> <span class="token literal-property property">count</span><span class="token operator">:</span> local<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>local<span class="token punctuation">,</span> <span class="token literal-property property">ts</span><span class="token operator">:</span> remote<span class="token punctuation">.</span>ts<span class="token punctuation">,</span> <span class="token literal-property property">count</span><span class="token operator">:</span> remote<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>If the local wall clock is later than both the local and remote timestamps, great! Use it, and reset the count to <code class="language-javascript"><span class="token number">0</span></code>.</p>

<p>Otherwise, the wall clock is somehow behind ‚Äì either behind the remote HLC (it could be that the remote device has a fast clock), or behind the local one (if the clock jumped backward, or our HLC was previously updated from another node that had a faster clock).</p>

<p>If both HLC‚Äôs timestamps are the same, we need a new count that‚Äôs larger than either of theirs. Otherwise, use the later timestamp of the two, and a count that‚Äôs one greater than the associated HLC‚Äôs counter.</p>

<h2 id="Cmp" tabindex="-1"><a class="header-anchor" href="#Cmp">Cmp</a></h2>

<p>Comparing HLCs is quite simple: first compare the timestamps, then the counts, then the node ids as the final tie-breaker.</p>

<pre><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">cmp</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">one</span><span class="token operator">:</span> <span class="token constant">HLC</span><span class="token punctuation">,</span> <span class="token literal-property property">two</span><span class="token operator">:</span> <span class="token constant">HLC</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>one<span class="token punctuation">.</span>ts <span class="token operator">===</span> two<span class="token punctuation">.</span>ts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>one<span class="token punctuation">.</span>count <span class="token operator">===</span> two<span class="token punctuation">.</span>count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>one<span class="token punctuation">.</span>node <span class="token operator">===</span> two<span class="token punctuation">.</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> one<span class="token punctuation">.</span>node <span class="token operator">&lt;</span> two<span class="token punctuation">.</span>node <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> one<span class="token punctuation">.</span>count <span class="token operator">-</span> two<span class="token punctuation">.</span>count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> one<span class="token punctuation">.</span>ts <span class="token operator">-</span> two<span class="token punctuation">.</span>ts<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<div class='note'><p>If you‚Äôre unfamiliar with the <code class="language-javascript">cmp</code> function convention, it‚Äôs a function that takes two arguments, and returns a negative number if the first argument is ‚Äúless‚Äù, a positive number if the second argument is ‚Äúless‚Äù, and <code class="language-javascript"><span class="token number">0</span></code> if they are equal. You can pass this <code class="language-javascript">cmp</code> function to <code class="language-javascript"><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code> of an array of <code class="language-javascript"><span class="token constant">HLC</span></code>s, and it will order them from ‚Äúearliest‚Äù to ‚Äúlatest‚Äù.</p>
</div>
<p>In practice, it‚Äôs convenient to ‚Äúpack‚Äù the HLC into a string representation, such that you can do normal lexical comparisons (&lt; and &gt;) on them, and generally pass them around more easily. The original paper sacrifices some precision on the timestamp to pack all the information into an integer, but for my purposes strings generally work fine.</p>

<pre><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">pack</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> ts<span class="token punctuation">,</span> count<span class="token punctuation">,</span> node <span class="token punctuation">}</span><span class="token operator">:</span> <span class="token constant">HLC</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// 13 digits is enough for the next 100 years, so 15 is plenty.</span>
    <span class="token comment">// And 5 digits base 36 is enough for more than 6 million "out of order" changes.</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        ts<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token operator">+</span>
        <span class="token string">':'</span> <span class="token operator">+</span>
        count<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token operator">+</span>
        <span class="token string">':'</span> <span class="token operator">+</span>
        node
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">unpack</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">serialized</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>ts<span class="token punctuation">,</span> count<span class="token punctuation">,</span> <span class="token operator">...</span>node<span class="token punctuation">]</span> <span class="token operator">=</span> serialized<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">ts</span><span class="token operator">:</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">node</span><span class="token operator">:</span> node<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<h1 id="But-wait" tabindex="-1"><a class="header-anchor" href="#But-wait">But wait</a></h1>

<p>A case that it <em>doesn‚Äôt</em> cover is this: if A sets their clock ahead &amp; makes some changes, but doesn‚Äôt send them, and then B makes some changes, and <em>then</em> A sends their changes, A‚Äôs <em>earlier</em> changes will be ordered <em>after</em> B‚Äôs <em>later</em> changes. Upon closer inspection however, this isn‚Äôt a huge problem. From B‚Äôs perspective, if it hasn‚Äôt seen the changes, they might as well have not yet happened. Is there a real difference here between A making changes, waiting, then sending; and A waiting, then making changes and sending them immediately? You could think of them being logically equivelent, and in fact the HLC considers them to be.</p>

<p>A real world example of this issue would be if a user has two devices, both offline, but device A is somehow an hour ahead of device B. The user makes a change on device A, then walks over to device B and makes a conflicting change, logically thinking that the change on B will win, because it is ‚Äúlast‚Äù. Once both devices come online, the change from device A has won, much to the user‚Äôs surprise. In practice, you‚Äôll want to do some checks on timestamps your server is getting from clients, and raise a red flag if their too out of sync.</p>

<p>For the most part, if users clocks aren‚Äôt too far off, then changes that happen ‚Äúin parallel‚Äù (while both are offline, for example) will be ordered correctly.</p>

<h1 id="That-s-it" tabindex="-1"><a class="header-anchor" href="#That-s-it">That‚Äôs it!</a></h1>

<p>I made a <a href="https://hybrid-logical-clocks-example.surge.sh/">demo app</a> to help myself gain some intuition about how HLCs interacted with each other in a distributed system (<a href="https://github.com/jaredly/hybrid-logical-clocks-example">source here</a>) ‚Äì feel free to play with it, and let me know what you think <a href="https://twitter.com/jaredforsyth">on twitter</a>!</p>

</div>

 
</article>
</main>
<div style="height: 128px"></div>
</div>
<div style="flex-basis: 100px; flex-shrink: 1" class="style-ce615c601d9c9081e34880573a9c0d6582fa6737"></div>
</div>
</body>
</html>