<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf8">
<meta name="description" content="How to communicate safely and unsafely with the host language."/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="HandheldFriendly" content="True"/>
<meta name="MobileOptimized" content="320"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="JavaScript Interop with Reason and BuckleScript | Jared Forsyth.com"/>
<meta name="twitter:description" content="How to communicate safely and unsafely with the host language."/>
<meta name="twitter:image" content="https://jaredforsyth.com/images/logo/JF_black_128.png"/>
<meta name="twitter:site" content="https://jaredforsyth.com"/>
<meta name="twitter:creator" content="@jaredforsyth"/>
<meta property="og:type" content="article"/>
<meta property="og:title" content="JavaScript Interop with Reason and BuckleScript | Jared Forsyth.com"/>
<meta property="og:description" content="How to communicate safely and unsafely with the host language."/>
<link rel="shortcut icon" href="/images/logo/JF_black_32.png"></link>
<title>JavaScript Interop with Reason and BuckleScript | Jared Forsyth.com</title>
<link rel="stylesheet" href="//brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i"></link>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata:400,700"></link>
<style>

      div {
        flex-shrink: 0;
        flex-wrap: wrap;
        box-sizing: border-box;
        min-height: 0;
        min-width: 0;
      }
      span {
        box-sizing: border-box;
      }
      pre {
        line-height: 18px;
        font-size: 16px;
        /* white-space: pre-wrap; */
        overflow: auto;
        max-width: 100%;
        padding: 15px;
        /* border: 1px solid #ddd; */
        font-family: Inconsolata;
        background-color: #fff4ef;
        color: #692900;
        border-radius: 4px;
        margin: 0;
        margin-bottom: 1em;
      }
      img {
        max-width: 100%;
      }
      li > code,
      a > code,
      p > code {
        font-size: 90%;
        padding: 4px;
        background-color: #ffede4;
        color: #692900;
        border-radius: 4px;
        hyphens: none;
      }
      blockquote {
          margin: 0;
          margin-bottom: 1em;
          padding-left: 20px;
          border-left: 5px solid #1fad3e;
          font-style: italic;
      }
      blockquote.twitter-tweet {
        font-style: normal;
        border: 1px solid #1fad3e;
        border-radius: 4px;
        padding: 8px 16px;
        font-size: 20px;
      }
      a {
        color: #1fad3e;
        /* color: #28cc4c;
        text-decoration-color: #28cc4c; */
      }
      h2 {
        padding-bottom: 16px;
        font-size: 36px;
        margin: 0;
        margin-top: 1em;
      }
      p {
        margin: 0;
        padding-bottom: 1em;
      }
      blockquote > p:last-child {
        padding-bottom: 0;
      }
      h3 {
        margin-bottom: 8px;
        font-family: Open sans;
        font-weight: normal;
        margin-top: 8px;
        color: #6e6e6e;
        font-size: 30px;
      }
      h5 {
        font-family: open sans;
        margin: 0;
        margin-top: 16px;
      }
      /* a:visited {
        color: #333;
      } */
      
</style>
<style>
.style-562977262 {
  max-width: 700px;
}
@media(max-width: 1060px) {
.style-562977262 {
  flex-shrink: 1;
  min-width: 0;
}
}
.style-362825327 {
  display: block;
  width: 160px;
  height: 160px;
}
.style-105406039 {
  font-size: 24px;
  line-height: 36px;
  hyphens: auto;
}
@media(max-width: 600px) {
.style-105406039 {
  font-size: 20px;
  line-height: 30px;
}
}
.style-378508498 {
  color: #999;
  font-family: Open sans;
  font-size: 14px;
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: flex-start;
}
.style-254026428 {
  font-family: Open sans, sans-serif;
  font-size: 20px;
}
.style-254026428 a {
  text-decoration: none;
}
.style-254026428 a:hover {
  text-decoration: underline;
}
.style-231757563 {
  font-family: Linux Libertine;
  color: #333;
  margin: 0;
  padding: 0;
}
.style-665563595 {
  flex-shrink: 1;
  overflow: auto;
}
.style-723831218 {
  font-size: 24px;
  line-height: 36px;
  flex: 1;
  display: flex;
  flex-direction: column;
  flex-wrap: nowrap;
  text-align: left;
}
.style-679839639 {
  background-color: #fff4ef;
  max-width: 400px;
  flex-shrink: 1;
  min-width: 300px;
  padding: 40px;
}
@media(max-width: 835px) {
.style-679839639 {
  padding: 16px;
}
}
@media(max-width: 1650px) {
.style-679839639 {
  padding: 20px;
}
}
@media(max-width: 1060px) {
.style-679839639 {
  display: none;
}
}
.style-74395582 {
  color: #999;
  display: flex;
  flex-direction: row;
}
.style-129913994 {

}
.style-507597651 {
  text-decoration: none;
}
.style-627275581 {
  margin-top: 100px;
  font-size: 56px;
  margin-bottom: 16px;
  padding-top: 32px;
}
@media(max-width: 600px) {
.style-627275581 {
  font-size: 32px;
  margin-top: 40px;
}
}
@media(max-width: 600px) {
.style-627275581 {
  margin-top: 40px;
}
}
.style-817623655 {
  padding: 0 16px;
  flex-shrink: 1;
  overflow: auto;
}
.style-760303782 {
  margin-bottom: 40px;
  justify-content: center;
  display: flex;
  flex-direction: row;
}
.style-760303782 a {
  margin: 0 8px;
}
.style-179062008 {
  flex-direction: row;
  padding: 0 20px;
  display: flex;
  justify-content: center;
  align-items: stretch;
  flex-wrap: wrap;
  justify-content: flex-start;
  flex-wrap: nowrap;
}
@media(max-width: 1060px) {
.style-179062008 {
  justify-content: center;
}
}
@media(max-width: 835px) {
.style-179062008 {
  padding: 8px;
}
}
.style-504547095 {
  margin: 0 auto;
  width: 160px;
  overflow: hidden;
  height: 160px;
  display: block;
  border-radius: 50%;
  border: 5px solid white;
  background-color: white;
  box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3);
}
.style-310129452 {
  text-align: center;
  font-size: 36px;
}
.style-580730263 {
  top: 40px;
}
@media(max-width: 835px) {
.style-580730263 {
  top: 16px;
}
}
@media(max-width: 1650px) {
.style-580730263 {
  top: 20px;
}
}
@media(min-width: 835px) {
.style-580730263 {
  position: sticky;
  height: calc(100vh - 40px);
  display: flex;
  flex-wrap: nowrap;
  flex-direction: column;
}
}
.style-466863072 {

}
@media(max-width: 1060px) {
.style-466863072 {
  display: none;
}
}
.style-245007015 {
  font-size: 16px;
  margin-bottom: 16px;
  display: block;
  line-height: 20px;
  color: currentColor;
  text-decoration: none;
}
.style-245007015:hover {
  text-decoration: underline;
}
</style>
</head>
<body class="style-231757563" lang="en">
<div class="style-179062008">
<div class="style-679839639">
<div class="style-580730263">
<a href="/" class="style-504547095"><img src="https://www.gravatar.com/avatar/313878fc8f316fc3fe4443b13913d0a4.png?s=200" alt="Jared Forsyth" class="style-362825327"/></a>
<div style="height: 40px"></div>
<div class="style-310129452">I'm Jared Forsyth</div>
<div style="height: 40px"></div>
<div class="style-723831218">
<div class="style-760303782">
<a href="/">home</a>
<a href="/posts/">posts</a>
<a href="/projects/">projects</a>
<a href="/talks/">talks</a>
</div>
<div class="style-817623655">
<div class="style-129913994">Recent posts</div>
<div style="height: 8px"></div>
<a href="/posts/hot-reloading-ocaml-on-web-desktop-and-android/" class="style-245007015">
<div>Hot-reloading OCaml on Web, Desktop, and Android</div>
<div class="style-74395582">
2018
January
23
</div>
</a>
<a href="/posts/reason-mobile-cross-compilation-deep-dive/" class="style-245007015">
<div>Reason mobile cross-compilation deep dive</div>
<div class="style-74395582">
2018
January
23
</div>
</a>
<a href="/posts/making-a-cross-platform-mobile-game-in-reason-ocaml/" class="style-245007015">
<div>Making a cross-platform mobile game in Reason/OCaml</div>
<div class="style-74395582">
2018
January
13
</div>
</a>
<a href="/posts/building-async-await-in-reason/" class="style-245007015">
<div>Building async/await in Reason</div>
<div class="style-74395582">
2017
December
30
</div>
</a>
<a href="/posts/advanced-reasonreact-hider-order-components/" class="style-245007015">
<div>Advanced ReasonReact: Higher Order Components</div>
<div class="style-74395582">
2017
November
12
</div>
</a>
















<div style="height: 32px"></div>
</div>
<div class="style-254026428" style="text-align:center">
<a href="https://twitter.com/jaredforsyth">twitter/@jaredforsyth</a>
<br/>
<a href="https://github.com/jaredly">github/@jaredly</a>
</div>
</div>
</div>
</div>
<div class="style-466863072" style="flex-basis: 100px; flex-shrink: 1"></div>
<div class="style-562977262">
<main role="main">
<article>
<h1 class="style-627275581">JavaScript Interop with Reason and BuckleScript</h1>
<div class="style-378508498">
June
<div style="flex-basis: 4px"></div>
3,
<div style="flex-basis: 4px"></div>
2017
<div style="flex-basis: 8px"></div>
 Â· 
<div style="flex-basis: 8px"></div>
<a href="/tags/tutorial/" class="style-507597651">tutorial</a>, <div style="flex-basis: 4px"></div><a href="/tags/ocaml/" class="style-507597651">ocaml</a>, <div style="flex-basis: 4px"></div><a href="/tags/reason/" class="style-507597651">reason</a>, <div style="flex-basis: 4px"></div><a href="/tags/javascript/" class="style-507597651">javascript</a>
</div>
<div style="height: 32px"></div>
<div class="style-105406039">
<p>So you&#39;re all ready to write some Reason but you need to call a JavaScript function? Or maybe you can&#39;t figure out how to write something in OCaml-land and wish you could just bail for a minute &amp; write it in JavaScript? Fortunately, both of those are fairly easy to pull off.</p>
<!-- more -->

<p>If you don&#39;t already have Reason + BuckleScript set up on your machine, head over to the <a href="http://jaredforsyth.com/2017/06/03/getting-started-with-reason-and-bucklescript/" target="_blank">&quot;Getting Started&quot; blog post</a> or clone <a href="https://github.com/jaredly/reason-bucklescript-example" target="_blank">this github repository</a> for a minimal boilerplate. If you want a primer on Reason syntax, the <a href="http://facebook.github.io/reason/" target="_blank">Reason documentation</a> provides a nice comparison to JavaScript.</p>
<blockquote><p>I&#39;ll be using Reason syntax instead of standard OCaml syntax because I like it much better :) but all of the stuff here applies to vanilla OCaml + Bucklescript as well, and the syntax is quite similar. The latest version of Bucklescript as of this writing is 1.7.4, so if yours is later than that, some details might be different. In all of this, you can consult the excellent <a href="http://bucklescript.github.io/bucklescript/Manual.html" target="_blank">Bucklescript documentation</a>.</p>
</blockquote>

<h2 id="Just-dumping-JavaScript-in-the-middle-of-your-Reason-code">Just dumping JavaScript in the middle of your Reason code</h2>

<p>If you&#39;re just hacking things together, this can be very nice, but you also have all of the unsafety of JavaScript code ð.</p>
<pre class='ocaml'><code class='ocaml'>Js.log &quot;this is reason&quot;;
[%%bs.raw {|
console.log(&#39;here is some javascript for you&#39;);
|}];</code></pre>

<blockquote><p><code>{|</code> and <code>|}</code> are the delimeters of a multi-line string in OCaml. You can also put a tag in there e.g. <code>{something|</code> and then it will look for a matching <code>|something}</code> to close.</p>
</blockquote>

<p>And here&#39;s the resulting javascript:</p>
<pre class='javascript'><code class='javascript'>// Generated by BUCKLESCRIPT VERSION 1.7.4, PLEASE EDIT WITH CARE
&#39;use strict&#39;;
console.log(&quot;this is reason&quot;);
console.log(&#39;here is some javascript for you&#39;);</code></pre>

<h2 id="Dumping-in-some-JavaScript-and-making-it-accessible-from-Reason">Dumping in some JavaScript, and making it accessible from Reason</h2>

<p>What if you want a value that can be used from your Reason code?</p>
<pre class='ocaml'><code class='ocaml'>Js.log &quot;this is reason&quot;;
let x = [%bs.raw {| &#39;here is a string from javascript&#39; |}];
Js.log (x ^ &quot; back in reason land&quot;); /* ^ is the operator for string concat */</code></pre>

<p>Now you might be wondering &quot;what magic is this?? How did ocaml know that <code>x</code> was a string? <strong>It doesn&#39;t</strong>. The type of <code>x</code> in this code is a magic type that will unify with anything! This is quite dangerous and can have cascading effects in OCaml&#39;s type inference algorithm.</p>
<pre class='ocaml'><code class='ocaml'>let y = [%bs.raw {| &#39;something&#39; |}];
Js.log (&quot;a string&quot; ^ y, 10 + y);
/* danger!! ocaml won&#39;t stop you from using y as 2 totally different types */</code></pre>

<p>To fix this, you should <strong>always</strong> provide a concrete type for the result of <code>bs.raw</code>.</p>
<pre class='ocaml'><code class='ocaml'>let x: string = [%bs.raw {| &#39;well-typed&#39; |}];
Js.log (x ^ &quot; back in reason land&quot;);
/* ocaml will error out if you try to use x as anything other than a string */</code></pre>

<p>And here&#39;s the output!</p>
<pre class='javascript'><code class='javascript'>// Generated by BUCKLESCRIPT VERSION 1.7.4, PLEASE EDIT WITH CARE
&#39;use strict&#39;;
console.log(&quot;this is reason&quot;);
var x = ( &#39;here is a string from javascript&#39; );
console.log(x + &quot; back in reason land&quot;);
var y = ( &#39;something&#39; );
console.log(/* tuple */[
      &quot;a string&quot; + y,
      10 + y | 0
    ]);
var x$1 = ( &#39;well-typed&#39; );
console.log(x$1 + &quot; back in reason land&quot;);</code></pre>

<blockquote><p>The difference between the 2 <code>%%</code> from the previous section and the 1 <code>%</code> here is important! <code>[%%something ...]</code> is an OCaml &quot;extension point&quot; that represents a <em>top-level</em> statement (it can&#39;t show up inside a function or value, for example). <code>[%something ...]</code> is an extension point that stands in for an <em>expression</em>, and can be put just about anywhere -- but make sure that the JavaScript you put inside is actually an expression! E.g. don&#39;t put a semicolon after it, or you&#39;ll get a syntax error when you try to run the resulting JavaScript.</p>
</blockquote>

<h2 id="Dumping-in-a-function-amp-passing-values">Dumping in a function &amp; passing values</h2>

<p>We&#39;ll need a little knowledge about Bucklescript&#39;s runtime representation of various values for this to work.</p>
<ul><li><code>strings</code> are strings, <code>ints</code> and <code>floats</code> are just numbers</li><li>an <a href="http://facebook.github.io/reason/#built-in-data-types-array" target="_blank">Array</a> is a mutable fixed-length list in OCaml, and is represented as a plain javascript array.</li><li>a <a href="http://facebook.github.io/reason/#built-in-data-types-linked-list" target="_blank">List</a> is an immutable functional-style linked list, and is definitely the more idiomatic one to use in most cases. However, it&#39;s representation is more complicated (try <code>Js.log [1,2,3,4]</code> to check it out). Because of this, I generally convert to &amp; from <code>Array</code>s when I&#39;m talking to javascript, via <code>Array.of_list</code> and <code>Array.to_list</code>.</li><li>If you want to go deeper, there&#39;s an exhaustive list <a href="https://github.com/bucklescript/bucklescript/wiki/Runtime-representation" target="_blank">on the BuckleScript wiki</a></li></ul>

<p>Knowing that, we can write a function in JavaScript that just accepts an array and returns a number, without much trouble at all.</p>
<pre class='ocaml'><code class='ocaml'>let jsCalculate: array int =&gt; int =&gt; int = [%bs.raw {|
 function (numbers, scaleFactor) {
   var result = 0;
   numbers.forEach(number =&gt; {
     result += number;
   });
   return result * scaleFactor;
 }
|}];
let calculate numbers scaleFactor =&gt;
  jsCalculate (Array.of_list numbers) scaleFactor;
Js.log (calculate [1,2,3] 10); /* -&gt; 60 */</code></pre>

<p>Of course, this function that I wrote in JavaScript could be ported over to Reason without much hassle.</p>
<p><strong>Remember</strong> that this is an escape hatch that&#39;s very useful for learning so you can jump in quickly and make something, but it&#39;s a good exercise to go back through and convert things back into nice type safe reason code.</p>
<p>I&#39;ve run into more than a few bugs because of raw JavaScript that I added to save time ð.</p>
<h2 id="Settling-down-and-getting-disciplined-about-things">Settling down and getting disciplined about things</h2>

<p>So far we&#39;ve been using <code>bs.raw</code>, which is a very fast n loose way to do it, and <strong>not</strong> suitable for production.</p>
<p>But what if we actually need to call a function that&#39;s in JavaScript? It&#39;s needed for interacting with the DOM, or using node modules. In BuckleScript, you use an <code>external</code> declaration (<a href="http://bucklescript.github.io/bucklescript/Manual.html#_binding_to_simple_js_functions_values" target="_blank">docs</a>).</p>
<p>Getting a value and getting a function are both pretty easy:</p>
<pre class='ocaml'><code class='ocaml'>external pi: float = &quot;Math.PI&quot; [@@bs.val];
let tau = pi *. 2.0;
external alert: string =&gt; void = &quot;alert&quot; [@@bs.val];
alert &quot;hello&quot;;</code></pre>

<p>But what about when we want something more complicated? Here&#39;s how we could call <code>getContext</code> on a Canvas DOM node:</p>
<pre class='ocaml'><code class='ocaml'>type canvas;
type context;
/* we&#39;re leaving these types abstract, because we won&#39;t
 * be using them directly anywhere */
external getContext: canvas =&gt; string =&gt; context = &quot;&quot; [@@bs.send];
let myCanvas: canvas = [%bs.raw {| document.getElementById(&quot;mycanvas&quot;) |}];
let ctx = getContext myCanvas &quot;2d&quot;;</code></pre>

<p>So let&#39;s unpack what&#39;s going on. We created some abstract types for the Canvas DOM node and the associated RenderingContext object.</p>
<p>Then we made a <code>getContext</code> function, but instead of <code>@@bs.val</code> we used <code>@@bs.send</code>, and we used an empty string for the text of the external. <code>@@bs.send</code> means &quot;we&#39;re calling a method on the first argument&quot;, which in this case is the canvas. BuckleScript will translate this into <code>theFirstArgument.getContext(theSecondArgument, ...)</code>.</p>
<p>And the empty string means &quot;the js-name is the same as the name we&#39;re giving the external here in BuckleScript-land&quot;, in this case <code>getContext</code>. If we wanted to name it something else (like <code>getRenderingContext</code>), when we&#39;d have to supply the string <code>&quot;getContext&quot;</code> so that BuckleScript calls the right function.</p>
<p>Let&#39;s add one more function just so it&#39;s interesting.</p>
<pre class='ocaml'><code class='ocaml'>external fillRect: context =&gt; float =&gt; float =&gt; float =&gt; float =&gt; unit = &quot;&quot; [@@bs.send];</code></pre>

<p>And now we can draw something!</p>
<pre class='ocaml'><code class='ocaml'>fillRect ctx 0.0 0.0 100.0 100.0;</code></pre>

<p>It&#39;s not much, but adding other canvas methods is similar, and then you can start doing some <a href="https://twitter.com/jaredforsyth/status/871062358076030976" target="_blank">really fun things</a>.</p>
<p>So what does the compiled JavaScript look like?</p>
<pre class='javascript'><code class='javascript'>&#39;use strict&#39;;
var tau = Math.PI * 2.0;
alert(&quot;hello&quot;);
var myCanvas = ( document.getElementById(&quot;mycanvas&quot;) );
var ctx = myCanvas.getContext(&quot;2d&quot;);
ctx.fillRect(0.0, 0.0, 100.0, 100.0);</code></pre>

<p>Wow! Notice how BuckleScript just inlined our <code>pi</code> variable for us? And the output looks almost exactly like it was written by hand.</p>
<h2 id="What-39-s-next">What&#39;s next?</h2>

<p>Join us in our <a href="https://discord.gg/reasonml" target="_blank">Discord channel!</a></p>
<p>Check out the <a href="https://github.com/chenglou/reason-react-example" target="_blank">reason-react-example</a> repository if you want to make some UIs.</p>
<p>Here are some repositories that make use of externals:</p>
<ul><li><a href="https://github.com/jaredly/reason-maze" target="_blank">https://github.com/jaredly/reason-maze</a></li><li><a href="https://github.com/jaredly/rsnpaint" target="_blank">https://github.com/jaredly/rsnpaint</a></li><li><a href="https://github.com/chenglou/MariOCaml" target="_blank">https://github.com/chenglou/MariOCaml</a> (OCaml, not Reason syntax)</li></ul>

<p>If you&#39;re starting into Reason, keep track of the things that confuse you and let us know! There&#39;s lots of documentation work to do, and it will be best if it&#39;s informed by people who are just starting out.</p>

</div>
</article>
</main>
<div style="height: 128px"></div>
</div>
<div class="style-466863072" style="flex-basis: 100px; flex-shrink: 1"></div>
</div>
</body>
</html>