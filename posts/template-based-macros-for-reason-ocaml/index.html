<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf8"/>
<meta name="description" content="Thoughts about a friendlier macro system."/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="HandheldFriendly" content="True"/>
<meta name="MobileOptimized" content="320"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Template-based macros in Reason/OCaml | Jared Forsyth.com"/>
<meta name="twitter:description" content="Thoughts about a friendlier macro system."/>
<meta name="twitter:image" content="https://jaredforsyth.com/images/logo/JF_black_128.png"/>
<meta name="twitter:site" content="https://jaredforsyth.com"/>
<meta name="twitter:creator" content="@jaredforsyth"/>
<meta property="og:type" content="article"/>
<meta property="og:title" content="Template-based macros in Reason/OCaml | Jared Forsyth.com"/>
<meta property="og:description" content="Thoughts about a friendlier macro system."/>
<link rel="shortcut icon" href="/images/logo/JF_black_32.png"></link>
<title>
 
Template-based macros in Reason/OCaml | Jared Forsyth.com
 
</title>
<link rel="stylesheet" href="//brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Merriweather:200,200i,400,400i,700,700i/Open+Sans:400,400i,700,700i"></link>
<link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel="stylesheet"></link>
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-one-light.min.css" rel="stylesheet" media="not (prefers-color-scheme: dark)"></link>
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-vsc-dark-plus.min.css" rel="stylesheet" media="(prefers-color-scheme: dark)"></link>
<script>
if (localStorage.viewMode) {
                    document.getElementsByTagName('html')[0].className = localStorage.viewMode;
                }
                window.addEventListener('load', () => {
                    const node = document.createElement('div');
                    const dark = document.createElement('a');
                    const light = document.createElement('a');
                    dark.className = 'dark-mode-button';
                    light.className = 'light-mode-button';

                    window.setMode = (mode) => {
                        if (localStorage.viewMode === mode) {
                            localStorage.viewMode = ''
                            document.getElementsByTagName('html')[0].className = 'mode-change'

                        } else {
                            localStorage.viewMode = mode
                            document.getElementsByTagName('html')[0].className = localStorage.viewMode + ' mode-change';
                        }
                    }
                    dark.onclick = (evt) => {
                        setMode('dark-mode');
                        evt.preventDefault()
                    }
                    light.onclick = (evt) => {
                        setMode('light-mode');
                        evt.preventDefault()
                    }

                    dark.textContent = 'dark mode';
                    dark.href = 'javascript:setMode("dark-mode")'
                    light.textContent = 'light mode';
                    light.href = 'javascript:setMode("light-mode")'
                    node.appendChild(dark)
                    node.appendChild(document.createTextNode(' ¬∑ '));
                    node.appendChild(light)
                    Object.assign(node.style, {
                        position: 'absolute',
                        top: '8px',
                        right: '8px',
                    });
                    document.body.appendChild(node);
                })
                
</script>
<style>

    html.mode-change {
        transition: background-color .1s ease;
    }
    html.light-mode, :root {
        
        --color-text: #333;
        --color-lightText: #999;
        --color-red: #692900;
        --color-lightOrange: #fff4ef;
        --color-darkGreen: #147429;
        --color-green: #1fad3e;
        --color-code: #ffede4;
        --color-codeText: #692900;
        background-color: white;
    
    }

    @media (prefers-color-scheme: dark) {
        :root {
            
        --color-text: #ccc;
        --color-lightText: #999;
        --color-red: #1dd442;
        --color-lightOrange: #0f0d0d;
        --color-darkGreen: #d8ac7e;
        --color-green: #ef8d27;
        --color-code: #361402;
        --color-codeText: #f9d6bf;
        background-color: #21262c;
    
        }
    }

    html.dark-mode {
        
        --color-text: #ccc;
        --color-lightText: #999;
        --color-red: #1dd442;
        --color-lightOrange: #0f0d0d;
        --color-darkGreen: #d8ac7e;
        --color-green: #ef8d27;
        --color-code: #361402;
        --color-codeText: #f9d6bf;
        background-color: #21262c;
    
    }

    main a:not([href^="/"]):not([href^="#"]):after {
        color: red;
        content: 'üåê';
        font-size: 70%;
        margin-left: 4px;
    }

    .dark-mode-button, .light-mode-button {
        text-decoration: none;
        color: var(--color-text);
    }

    html.dark-mode .dark-mode-button,
    html.light-mode .light-mode-button {
        text-decoration: underline;
        color: var(--color-green);
    }

    code[class*=language-], pre[class*=language-] {
        font-size: 90% !important;
    }

      div {
        flex-shrink: 0;
        flex-wrap: wrap;
        box-sizing: border-box;
        min-height: 0;
        min-width: 0;
      }
      span {
        box-sizing: border-box;
      }
      code[class*=language-], pre[class*=language-],
      pre {
        margin: 0;
        margin-bottom: 1.5em;
      }
      pre {
        line-height: 18px;
        font-size: 16px;
        /* white-space: pre-wrap; */
        overflow: auto;
        max-width: 100%;
        padding: 15px;
        /* border: 1px solid #ddd; */
        font-family: Inconsolata;
        background-color: var(--color-code);
        color: var(--color-codeText);
        border-radius: 4px;
      }
      img {
        max-width: 100%;
      }
      li > code,
      a > code,
      p > code {
        font-size: 90%;
        padding: 4px;
        background-color: var(--color-code);
        color: var(--color-codeText);
        border-radius: 4px;
        hyphens: none;
      }
      blockquote {
          margin: 0;
          margin-bottom: 1em;
          padding-left: 20px;
          border-left: 5px solid var(--color-green);
          font-style: italic;
      }
      blockquote.twitter-tweet {
        font-style: normal;
        border: 1px solid var(--color-green);
        border-radius: 4px;
        padding: 8px 16px;
        font-size: 20px;
      }
      div.note {
        font-style: italic;
        flex-wrap: nowrap;
        display: flex;
        align-items: flex-start;
        font-size: 90%;
      }
      div.note::before {
        margin-right: 8px;
        content: 'i';
        border: 1px solid #ccc;
        padding: 2px 10px;
        border-radius: 50px;
        font-family: arial;
        font-style: normal;
        font-size: 20px;
        display: inline;
        line-height: 1;
        margin-top: 5px;
      }
      a {
        color: var(--color-green);
        text-decoration: none;
        /* color: #28cc4c;
        text-decoration-color: #28cc4c; */
      }
      a:hover {
        text-decoration: underline;
      }
      h1 > a, h2 > a, h3 > a, h4 > a, h5 > a, h6 > a {
        text-decoration: none;
        color: inherit;
      }
      h1 > a:hover, h2 > a:hover, h3 > a:hover, h4 > a:hover, h5 > a:hover, h6 > a:hover,
      h1 > a:focus, h2 > a:focus, h3 > a:focus, h4 > a:focus, h5 > a:focus, h6 > a:focus {
        text-decoration: underline;
        color: var(--color-green);
      }
      ul, ol {
        margin-top: 0;
      }
      .post-body h1 {
        font-family: Open sans;
      }
      h2 {
        padding-bottom: 16px;
        font-size: 32px;
        margin: 0;
        margin-top: 1em;
      }
      p {
        margin: 0;
        padding-bottom: 1em;
      }
      blockquote > p:last-child {
        padding-bottom: 0;
      }
      h3 {
        margin-bottom: 8px;
        font-family: Open sans;
        font-weight: normal;
        margin-top: 8px;
        color: #6e6e6e;
        font-size: 30px;
      }
      h5 {
        font-family: open sans;
        margin: 0;
        margin-top: 16px;
      }
      /* a:visited {
        color: #333;
      } */
      
</style>
<style>
 
.style-bb1ef180179301565afe9016b11ab16ed7413965 {
  padding: 0 16px;
  flex-shrink: 1;
  overflow: auto;
}
.style-6ae0154d10d8b0dbf4c75fa5adb959a39f9a7739 {
  text-decoration: none;
  color: inherit;
}
.style-6ae0154d10d8b0dbf4c75fa5adb959a39f9a7739:hover {
  text-decoration: underline;
}
.style-989db2448f309bfdd99b513f37c84b8f5794d2b5 {

}
.style-0044f7a33153e82f3678591650843ffdc0f020fe {
  font-size: 16px;
  margin-bottom: 16px;
  display: block;
  line-height: 20px;
  color: currentColor;
  text-decoration: none;
}
.style-0044f7a33153e82f3678591650843ffdc0f020fe:hover {
  text-decoration: underline;
}
.style-600fca2a90c30e17c2a20ea4f2f653cf60098d5b {
  color: var(--color-lightText);
  display: flex;
  flex-direction: row;
}
.style-92b92032b41d8e558573c6926aeaeeb3456b873e {
  margin-top: 100px;
  font-size: 56px;
  margin-bottom: 16px;
  padding-top: 32px;
}
@media(max-width: 600px) {
.style-92b92032b41d8e558573c6926aeaeeb3456b873e {
  font-size: 32px;
  margin-top: 40px;
}
}
@media(max-width: 600px) {
.style-92b92032b41d8e558573c6926aeaeeb3456b873e {
  margin-top: 40px;
}
}
.style-d9a01dccc38720dfd616bfebd6cb0499248e200b {
  color: var(--color-lightText);
  font-family: Open sans;
  font-size: 14px;
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: flex-start;
}
.style-fde29ab0420a52958e612784d49ff404f48528ae {
  text-decoration: none;
}
.style-cda9f9781eb5258ad50a00716278a6233b0a6313 {
  font-size: 22px;
  line-height: 40px;
  hyphens: auto;
  font-family: Merriweather;
  font-weight: 200;
}
@media(max-width: 600px) {
.style-cda9f9781eb5258ad50a00716278a6233b0a6313 {
  font-size: 20px;
  line-height: 30px;
}
}
.style-cd92fd8450a8c6641a2f0f2f0daac33e94b99b35 {
  font-family: Linux Libertine;
  color: var(--color-text);
  margin: 0;
  padding: 0;
}
.style-0da148fa6be0269fa24b9fd57a9a57aeb5297d0d {
  flex-direction: row;
  padding: 0 20px;
  display: flex;
  justify-content: center;
  align-items: stretch;
  flex-wrap: wrap;
  justify-content: flex-start;
  flex-wrap: nowrap;
}
@media(max-width: 1060px) {
.style-0da148fa6be0269fa24b9fd57a9a57aeb5297d0d {
  justify-content: center;
}
}
@media(max-width: 835px) {
.style-0da148fa6be0269fa24b9fd57a9a57aeb5297d0d {
  padding: 8px;
}
}
.style-9dc27aab0a26df3e65720efcd4de1d4b5e9e64f8 {
  background-color: var(--color-lightOrange);
  max-width: 400px;
  flex-shrink: 1;
  min-width: 300px;
  padding: 40px;
}
@media(max-width: 835px) {
.style-9dc27aab0a26df3e65720efcd4de1d4b5e9e64f8 {
  padding: 16px;
}
}
@media(max-width: 1650px) {
.style-9dc27aab0a26df3e65720efcd4de1d4b5e9e64f8 {
  padding: 20px;
}
}
@media(max-width: 1060px) {
.style-9dc27aab0a26df3e65720efcd4de1d4b5e9e64f8 {
  display: none;
}
}
.style-070d16e7de42659938f24594f2b149329d23dc29 {
  top: 40px;
}
@media(max-width: 835px) {
.style-070d16e7de42659938f24594f2b149329d23dc29 {
  top: 16px;
}
}
@media(max-width: 1650px) {
.style-070d16e7de42659938f24594f2b149329d23dc29 {
  top: 20px;
}
}
@media(min-width: 835px) {
.style-070d16e7de42659938f24594f2b149329d23dc29 {
  position: sticky;
  height: calc(100vh - 80px);
  display: flex;
  flex-wrap: nowrap;
  flex-direction: column;
}
}
.style-3ba81e27d2f8c377a36c12c6516f97660ec3facb {
  margin: 0 auto;
  width: 160px;
  overflow: hidden;
  height: 160px;
  display: block;
  border-radius: 50%;
  border: 5px solid white;
  background-color: white;
  box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3);
}
.style-1acf1679204e721558d0d3292da71a07307421a4 {
  display: block;
  width: 160px;
  height: 160px;
}
.style-0038018cf11394bd2f3cad50b7fc1d34d431f8b0 {
  text-align: center;
  font-size: 36px;
}
.style-683404bf430036582caafb930681970b717e3e38 {
  font-size: 24px;
  line-height: 36px;
  flex: 1;
  display: flex;
  flex-direction: column;
  flex-wrap: nowrap;
  text-align: left;
}
.style-da667265deef9362aecb588a818eaba3fef53068 {
  margin-bottom: 40px;
  justify-content: center;
  display: flex;
  flex-direction: row;
}
.style-da667265deef9362aecb588a818eaba3fef53068 a {
  margin: 0 8px;
}
.style-74e366023ce61639103d5fb83af3a27e33357285 {
  font-family: Open sans, sans-serif;
  font-size: 20px;
}
.style-74e366023ce61639103d5fb83af3a27e33357285 a {
  text-decoration: none;
}
.style-74e366023ce61639103d5fb83af3a27e33357285 a:hover {
  text-decoration: underline;
}
.style-ce615c601d9c9081e34880573a9c0d6582fa6737 {

}
@media(max-width: 1060px) {
.style-ce615c601d9c9081e34880573a9c0d6582fa6737 {
  display: none;
}
}
.style-cea2d442503956980c7eeb14acb78a14064ee9d4 {
  max-width: 700px;
}
@media(max-width: 1060px) {
.style-cea2d442503956980c7eeb14acb78a14064ee9d4 {
  flex-shrink: 1;
  min-width: 0;
}
}
 
</style>

                
</head>
<body class="style-cd92fd8450a8c6641a2f0f2f0daac33e94b99b35" lang="en">
<div class="style-0da148fa6be0269fa24b9fd57a9a57aeb5297d0d">
<div class="style-9dc27aab0a26df3e65720efcd4de1d4b5e9e64f8">
<div class="style-070d16e7de42659938f24594f2b149329d23dc29">
<a href="/" class="style-3ba81e27d2f8c377a36c12c6516f97660ec3facb"><img src="https://www.gravatar.com/avatar/313878fc8f316fc3fe4443b13913d0a4.png?s=200" alt="Jared Forsyth" class="style-1acf1679204e721558d0d3292da71a07307421a4"/></a>
<div style="height: 40px"></div>
<div class="style-0038018cf11394bd2f3cad50b7fc1d34d431f8b0">I'm Jared Forsyth</div>
<div style="height: 40px"></div>
<div class="style-683404bf430036582caafb930681970b717e3e38">
<div class="style-da667265deef9362aecb588a818eaba3fef53068">
<a href="/">home</a>
<a href="/posts/">posts</a>
<a href="/projects/">projects</a>
<a href="/talks/">talks</a>
</div>
<div class="style-bb1ef180179301565afe9016b11ab16ed7413965">
<a href="/posts/" class="style-6ae0154d10d8b0dbf4c75fa5adb959a39f9a7739"><div class="style-989db2448f309bfdd99b513f37c84b8f5794d2b5">Latest posts</div></a>
<div style="height: 8px"></div>
<a href="/posts/type-inference-that-sticks/" class="style-0044f7a33153e82f3678591650843ffdc0f020fe">
<div>
 
Type inference that sticks
 
</div>
<div class="style-600fca2a90c30e17c2a20ea4f2f653cf60098d5b">
2023
February
4
</div>
</a>
<a href="/posts/whats-cool-about-unison/" class="style-0044f7a33153e82f3678591650843ffdc0f020fe">
<div>
 
What's cool about Unison?
 
</div>
<div class="style-600fca2a90c30e17c2a20ea4f2f653cf60098d5b">
2021
March
2
</div>
</a>
<a href="/posts/local-first-database-hypermerge/" class="style-0044f7a33153e82f3678591650843ffdc0f020fe">
<div>
 
Local-first database: Hypermerge
 
</div>
<div class="style-600fca2a90c30e17c2a20ea4f2f653cf60098d5b">
2020
September
30
</div>
</a>
<a href="/posts/local-first-database-rxdb-pouchdb/" class="style-0044f7a33153e82f3678591650843ffdc0f020fe">
<div>
 
Local-first database: RxDB + PouchDB
 
</div>
<div class="style-600fca2a90c30e17c2a20ea4f2f653cf60098d5b">
2020
May
12
</div>
</a>
<a href="/posts/local-first-database-remotestorage/" class="style-0044f7a33153e82f3678591650843ffdc0f020fe">
<div>
 
Local-first database: remoteStorage.js
 
</div>
<div class="style-600fca2a90c30e17c2a20ea4f2f653cf60098d5b">
2020
May
6
</div>
</a>
<div style="height: 32px"></div>
</div>
<div style="text-align:center" class="style-74e366023ce61639103d5fb83af3a27e33357285">
<a href="https://twitter.com/jaredforsyth">twitter/@jaredforsyth</a>
<br/>
<a href="https://mastodon.social/@jaredly">@jaredly@mastodon.social</a>
<br/>
<a href="https://github.com/jaredly">github/@jaredly</a>
<br/>
<a href="/posts/rss.xml">posts rss feed</a>
</div>
</div>
</div>
</div>
<div style="flex-basis: 100px; flex-shrink: 1" class="style-ce615c601d9c9081e34880573a9c0d6582fa6737"></div>
<div class="style-cea2d442503956980c7eeb14acb78a14064ee9d4">
<main role="main">
<article>
 
<h1 class="style-92b92032b41d8e558573c6926aeaeeb3456b873e">Template-based macros in Reason/OCaml</h1>
<div class="style-d9a01dccc38720dfd616bfebd6cb0499248e200b">
June
<div style="flex-basis: 4px"></div>
20,
<div style="flex-basis: 4px"></div>
2017
<div style="flex-basis: 8px"></div>
 ¬∑ 
<div style="flex-basis: 8px"></div>
<a href="/tags/macros/" class="style-fde29ab0420a52958e612784d49ff404f48528ae">macros</a>, <div style="flex-basis: 4px"></div><a href="/tags/ocaml/" class="style-fde29ab0420a52958e612784d49ff404f48528ae">ocaml</a>, <div style="flex-basis: 4px"></div><a href="/tags/reason/" class="style-fde29ab0420a52958e612784d49ff404f48528ae">reason</a>
<div style="flex-basis: 8px"></div>

</div>
<div style="height: 32px"></div>
<div class="post-body style-cda9f9781eb5258ad50a00716278a6233b0a6313">
<p>A couple of people have shown up in <a href="https://discord.gg/reasonml">the discord channel</a> asking whether Reason has macros, and the answer is ‚Äúsort of.‚Äù I think we can do better.</p>
<!-- more -->
<p>OCaml has a feature called ‚Äúsyntax extensions‚Äù, which are well-defined syntax structures that are there specifically for some plugin to take &amp; transform into something else. The plugin that you include (referred to as a <code class="language-javascript">ppx</code>), then is passed the whole AST of your file, and it can do anything it wants to it. In general, it will look for these syntax extensions that it knows how to process, and limit transformations to just those nodes.</p>
<p>The best explanation of syntax extensions is from whitequark, and has a big ‚Äúthis is out of date‚Äù disclaimer at the top üòÖ <a href="https://whitequark.org/blog/2014/04/16/a-guide-to-extension-points-in-ocaml/">https://whitequark.org/blog/2014/04/16/a-guide-to-extension-points-in-ocaml/</a>.</p>
<h2 id="Why-do-we-need-anything-else" tabindex="-1"><a class="header-anchor" href="#Why-do-we-need-anything-else">Why do we need anything else?</a></h2>
<p>I was looking at the source of <a href="https://github.com/poeschko/bs-glamor">bs-glamor</a>, which is a wrapper around the css-in-js library <a href="https://github.com/threepointone/glamor">glamor</a>, and came across a familiar pattern ‚Äì <a href="https://github.com/poeschko/bs-glamor/blob/master/src/glamor.re">tons of boilerplate</a>.</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">let</span> azimouth <span class="token operator">=</span> <span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">Property</span><span class="token punctuation">(</span><span class="token string">"azimouth"</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> background <span class="token operator">=</span> <span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">Property</span><span class="token punctuation">(</span><span class="token string">"background"</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> backgroundAttachment <span class="token operator">=</span> <span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">Property</span><span class="token punctuation">(</span><span class="token string">"backgroundAttachment"</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* repeat for like 100 more properties */</span>
</code></pre>
<p>If this were javascript, we‚Äôd be able to just do</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">let</span> properties <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'azimouth'</span><span class="token punctuation">,</span> <span class="token string">'background'</span><span class="token punctuation">,</span> <span class="token comment">/* etc */</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> helpers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
properties<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  helpers<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token parameter">v</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Property</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>But this isn‚Äôt JavaScript, and you can‚Äôt dynamically create function names. Function names (and the types &amp; shape of modules) need to be known at compile time.</p>
<p>You could imagine a <code class="language-javascript">ppx</code> that goes through and looks for syntax like this, and does the appropriate transformation:</p>
<pre class="language-rust"><code class="language-rust"><span class="token punctuation">[</span><span class="token operator">%</span><span class="token operator">%</span>make_properties <span class="token punctuation">[</span>
  <span class="token string">"azimouth"</span><span class="token punctuation">,</span>
  <span class="token string">"background"</span><span class="token punctuation">,</span>
  <span class="token comment">/* etc */</span>
<span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre>
<p>But <code class="language-javascript">ppx</code>s take a fair bit of setting up, and it wouldn‚Äôt really feel worth it to go through and make one just to save you some typing. Might as well just use ‚Äúmulti-cursor mode‚Äù in your favorite editor and type it all out, and hope that you never have to change all of the declarations in the future.</p>
<h2 id="An-idea-from-Rust" tabindex="-1"><a class="header-anchor" href="#An-idea-from-Rust">An idea from Rust</a></h2>
<p>But there‚Äôs got to be a better way! Rust has a cool macro system that‚Äôs designed precisely for this kind of problem.</p>
<p>The best part is that you don‚Äôt have to know much about the Rust internal AST format, because this macro definition is template-based. Here‚Äôs an example from <a href="http://words.steveklabnik.com/an-overview-of-macros-in-rust">this excellent post</a>:</p>
<pre class="language-rust"><code class="language-rust"><span class="token macro property">macro_rules!</span> vec <span class="token punctuation">{</span>
    <span class="token punctuation">(</span> $<span class="token punctuation">(</span> <span class="token variable">$x</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">expr</span> <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> temp_vec <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            $<span class="token punctuation">(</span>
                temp_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">)</span><span class="token operator">*</span> <span class="token comment">// this means "repeat for each value of x"</span>
            temp_vec
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Then you can do <code class="language-javascript">vec<span class="token operator">!</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span></code> and it will be transformed into code that creates a vector and pushes into it.</p>
<h2 id="Taking-that-to-Reason-OCaml" tabindex="-1"><a class="header-anchor" href="#Taking-that-to-Reason-OCaml">Taking that to Reason/OCaml</a></h2>
<blockquote>
<p>This rest of this post might be fairly unintelligible if you aren‚Äôt familiar with OCaml, syntax extensions, and ppxs. Sorry!</p>
</blockquote>
<p>I could imagine a <code class="language-javascript">template_macros</code> ppx that lets you do this (I‚Äôm keeping the application parallel to rust, even though we already have list &amp; array literals):</p>
<pre class="language-rust"><code class="language-rust"><span class="token comment">/* at the top level */</span>
<span class="token punctuation">[</span><span class="token operator">@</span>let_macro<span class="token punctuation">.</span><span class="token function">vec</span><span class="token punctuation">(</span>items<span class="token punctuation">:</span> <span class="token function">list</span> <span class="token punctuation">(</span>expr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> temp_vec <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">[</span><span class="token operator">%</span><span class="token keyword">loop</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">vec_push</span><span class="token punctuation">(</span>temp_vec<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">%</span>expr item<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
  temp_vec<span class="token punctuation">;</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">/* somewhere in a function */</span>
<span class="token punctuation">[</span><span class="token operator">%</span>vec <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre>
<p>So how would this apply to our boilerplate earler?</p>
<pre class="language-rust"><code class="language-rust"><span class="token punctuation">[</span><span class="token operator">@</span>let_macro<span class="token punctuation">.</span><span class="token function">make_properties</span><span class="token punctuation">(</span>names<span class="token punctuation">:</span> <span class="token function">list</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">[</span><span class="token operator">%</span><span class="token operator">%</span><span class="token keyword">loop</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* all bound variables (such as `name`) can be used as
     * identifiers, and will be substituted. If the content
     * of the bound value is not an identifier
     * or a string, then an error is thrown.
     */</span>
    <span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">Property</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">%</span>string name<span class="token punctuation">]</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* results in `let color = (v) => Property("color", v);` */</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<p>And then we can use it the way we want to!</p>
<pre class="language-rust"><code class="language-rust"><span class="token punctuation">[</span><span class="token operator">%</span><span class="token operator">%</span>make_properties <span class="token punctuation">[</span>
  <span class="token string">"azimouth"</span><span class="token punctuation">,</span>
  <span class="token string">"background"</span><span class="token punctuation">,</span>
  <span class="token comment">/* etc */</span>
<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="Another-example" tabindex="-1"><a class="header-anchor" href="#Another-example">Another example</a></h2>
<p>What if we wanted to generate functors as well? It might look something like this:</p>
<pre class="language-rust"><code class="language-rust"><span class="token punctuation">[</span><span class="token operator">@</span>let_macro<span class="token punctuation">.</span><span class="token function">glamorous_factory</span><span class="token punctuation">(</span>node_types<span class="token punctuation">:</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Ident</span><span class="token punctuation">,</span> string<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">[</span><span class="token operator">%</span><span class="token operator">%</span><span class="token keyword">loop</span><span class="token punctuation">(</span>divs<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">FunctorName</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    module <span class="token class-name">FunctorName</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Config</span><span class="token punctuation">:</span> <span class="token class-name">GlamorousConfig</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">GlamorousFactory</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> elementName <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">%</span>string text<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Config</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token operator">%</span><span class="token operator">%</span>glamorous_factory <span class="token punctuation">[</span>
  <span class="token punctuation">(</span><span class="token class-name">Div</span><span class="token punctuation">,</span> <span class="token string">"div"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token class-name">Awesome</span><span class="token punctuation">,</span> <span class="token string">"awesome"</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="Some-weeds" tabindex="-1"><a class="header-anchor" href="#Some-weeds">Some weeds</a></h2>
<p>We can‚Äôt do the <code class="language-javascript">regex</code>-type thing that rust does, because OCaml extension points have to contain syntactically valid ASTs. My thought for the ‚Äúmacro arguments‚Äù specification would be</p>
<pre class="language-rust"><code class="language-rust">macro_definition<span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">@</span>let_macro<span class="token punctuation">.</span><span class="token operator">&lt;</span>macro_name<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&lt;</span>macro_argument<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>macro_argument<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">&lt;</span>macro_body<span class="token operator">></span>
<span class="token punctuation">]</span>

macro_name<span class="token operator">=</span> identifier

macro_argument<span class="token operator">=</span> identifier<span class="token punctuation">:</span> <span class="token operator">&lt;</span>argument_type<span class="token operator">></span>

argument_type<span class="token operator">=</span>
  <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span> string
  <span class="token closure-punctuation punctuation">|</span></span> int
  <span class="token operator">|</span> expr
  <span class="token operator">|</span> ident
  <span class="token operator">|</span> structure
  <span class="token operator">|</span> <span class="token keyword">type</span>
  <span class="token operator">|</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>argument_type<span class="token operator">></span><span class="token punctuation">)</span>
  <span class="token operator">|</span> <span class="token char">'('</span><span class="token operator">&lt;</span>argument_type<span class="token operator">></span><span class="token punctuation">(</span><span class="token char">','</span> <span class="token operator">&lt;</span>argument_type<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token char">')'</span><span class="token punctuation">;</span> <span class="token comment">/* a tuple literal */</span>
</code></pre>
<p>And then <code class="language-javascript">macro_body</code> would allow subsitutions of the form</p>
<pre class="language-rust"><code class="language-rust"><span class="token punctuation">[</span><span class="token operator">%</span>string arg_name<span class="token punctuation">]</span> <span class="token comment">/* a string literal -- will convert an identifier if given */</span>
<span class="token punctuation">[</span><span class="token operator">%</span>expr arg_name<span class="token punctuation">]</span> <span class="token comment">/* drop in as an expression */</span>
<span class="token punctuation">[</span><span class="token operator">%</span><span class="token keyword">type</span> <span class="token type-definition class-name">arg_name</span><span class="token punctuation">]</span> <span class="token comment">/* drop in as a type */</span>
<span class="token punctuation">[</span><span class="token operator">%</span><span class="token keyword">loop</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>list_arg<span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>bound_name<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">&lt;</span>loop_body<span class="token operator">></span>
<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token operator">%</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>start_int_or_arg_name<span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>end_<span class="token punctuation">...</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>bound_name<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token operator">@</span><span class="token operator">@</span><span class="token operator">@</span><span class="token function">gensym</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>bound_name<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* create an identifier that's guaranteed not to conflict */</span>
<span class="token punctuation">[</span><span class="token operator">@</span><span class="token operator">@</span><span class="token operator">@</span><span class="token function">ident</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>bound_name<span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>string_concat<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">where</span> <span class="token operator">&lt;</span>string_concat<span class="token operator">></span> is like `<span class="token string">"something_"</span> <span class="token operator">^</span> vbl_name`

</code></pre>
<p>And when invoking, the corresponding arguments would look like:</p>
<pre class="language-rust"><code class="language-rust">invocation<span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">%</span><span class="token operator">%</span><span class="token function">macro_name</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>arg_literal<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>arg_literal<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
string<span class="token operator">=</span> <span class="token string">"a literal string"</span>
int<span class="token operator">=</span> <span class="token number">23</span>
expr<span class="token operator">=</span> <span class="token comment">/* any expression literal */</span>
ident<span class="token operator">=</span> an_ident
structure<span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">%</span>structure <span class="token comment">/* now we can put any structure items in here */</span><span class="token punctuation">]</span>
<span class="token keyword">type</span><span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">%</span><span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token comment">/* now this is a type */</span><span class="token punctuation">]</span>
<span class="token function">list</span><span class="token punctuation">(</span>int<span class="token punctuation">)</span><span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
<span class="token punctuation">(</span>int<span class="token punctuation">,</span> int<span class="token punctuation">)</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">/* for the tuple literal */</span>
</code></pre>
<p>We‚Äôd also need some distinction between ‚Äústructure item‚Äù macros and ‚Äúexpression‚Äù macros I imagine. Would we want to make ‚Äúsignature‚Äù macros? I dunno.</p>
<h2 id="Comparison-to-existing-solutions" tabindex="-1"><a class="header-anchor" href="#Comparison-to-existing-solutions">Comparison to existing solutions</a></h2>
<p>.</p>
<h3 id="CPPO" tabindex="-1"><a class="header-anchor" href="#CPPO"><a href="https://github.com/mjambon/cppo">CPPO</a></a></h3>
<p>CPPO is for c-style ‚Äúuse this code if we‚Äôre targetting iOS 9.2, use thise other code if we‚Äôre targetting windows‚Äù. Which is quite different from eliminating boilerplate.</p>
<h3 id="Cinaps" tabindex="-1"><a class="header-anchor" href="#Cinaps"><a href="https://github.com/janestreet/cinaps">Cinaps</a></a></h3>
<p>Cinaps is similar in goal, but quite different in design. Both are targetted at fixing boilerplate with something that‚Äôs much less work than creating a ppx</p>
<p>Cinaps tackles the ‚Äúmake sure the code doesn‚Äôt get too confusing‚Äù problem by actually writing the resulting code to disk, and that‚Äôs the code you commit. Template-based macros tackle the problem by limiting the power of the tool ‚Äì you can‚Äôt do arbitrary transformations; you can only use templates, which (theoretically) make it pretty easy to understand what the output would be. I‚Äôd also want a cli (or IDE) tool where you enter a file name &amp; it shows you the transformed output. (For that matter, I‚Äôd love that for all ppxs).</p>
<h3 id="ppx_deriving" tabindex="-1"><a class="header-anchor" href="#ppx_deriving">ppx_deriving</a></h3>
<p>Making a ppx_deriving plugin is somewhat simpler than a full blown ppx, but it‚Äôs still complex enough that you‚Äôd only go to the trouble if you had a generalized pattern that you use a ton. Template-based macros are for one-offs.</p>
<h2 id="What-do-you-think" tabindex="-1"><a class="header-anchor" href="#What-do-you-think">What do you think?</a></h2>
<p>Let me know on <a href="https://discord.gg/reasonml">discord</a> @jaredly or twitter <a href="https://twitter.com/jaredforsyth">@jaredforsyth</a></p>

</div>

 
</article>
</main>
<div style="height: 128px"></div>
</div>
<div style="flex-basis: 100px; flex-shrink: 1" class="style-ce615c601d9c9081e34880573a9c0d6582fa6737"></div>
</div>
</body>
</html>