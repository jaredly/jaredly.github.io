<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf8">
<meta name="description" content="Evaluating gun.js for correctness, cost, and flexibility"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="HandheldFriendly" content="True"/>
<meta name="MobileOptimized" content="320"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Local-first database: gun.js | Jared Forsyth.com"/>
<meta name="twitter:description" content="Evaluating gun.js for correctness, cost, and flexibility"/>
<meta name="twitter:image" content="https://jaredforsyth.com/images/logo/JF_black_128.png"/>
<meta name="twitter:site" content="https://jaredforsyth.com"/>
<meta name="twitter:creator" content="@jaredforsyth"/>
<meta property="og:type" content="article"/>
<meta property="og:title" content="Local-first database: gun.js | Jared Forsyth.com"/>
<meta property="og:description" content="Evaluating gun.js for correctness, cost, and flexibility"/>
<link rel="shortcut icon" href="/images/logo/JF_black_32.png"></link>
<title>Local-first database: gun.js | Jared Forsyth.com</title>
<link rel="stylesheet" href="//brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i"></link>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata:400,700"></link>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/themes/prism.min.css"></link>
<style>

      div {
        flex-shrink: 0;
        flex-wrap: wrap;
        box-sizing: border-box;
        min-height: 0;
        min-width: 0;
      }
      span {
        box-sizing: border-box;
      }
      pre {
        line-height: 18px;
        font-size: 16px;
        /* white-space: pre-wrap; */
        overflow: auto;
        max-width: 100%;
        padding: 15px;
        /* border: 1px solid #ddd; */
        font-family: Inconsolata;
        background-color: #fff4ef;
        color: #692900;
        border-radius: 4px;
        margin: 0;
        margin-bottom: 1em;
      }
      img {
        max-width: 100%;
      }
      li > code,
      a > code,
      p > code {
        font-size: 90%;
        padding: 4px;
        background-color: #ffede4;
        color: #692900;
        border-radius: 4px;
        hyphens: none;
      }
      blockquote {
          margin: 0;
          margin-bottom: 1em;
          padding-left: 20px;
          border-left: 5px solid #1fad3e;
          font-style: italic;
      }
      blockquote.twitter-tweet {
        font-style: normal;
        border: 1px solid #1fad3e;
        border-radius: 4px;
        padding: 8px 16px;
        font-size: 20px;
      }
      div.note {
        font-style: italic;
        flex-wrap: nowrap;
        display: flex;
        align-items: flex-start;
        font-size: 90%;
      }
      div.note::before {
        margin-right: 8px;
        content: 'i';
        border: 1px solid #ccc;
        padding: 2px 10px;
        border-radius: 50px;
        font-family: arial;
        font-style: normal;
        font-size: 20px;
        display: inline;
        line-height: 1;
        margin-top: 5px;
      }
      a {
        color: #1fad3e;
        /* color: #28cc4c;
        text-decoration-color: #28cc4c; */
      }
      h1 > a, h2 > a, h3 > a, h4 > a, h5 > a, h6 > a {
        text-decoration: none;
        color: inherit;
      }
      h1 > a:hover, h2 > a:hover, h3 > a:hover, h4 > a:hover, h5 > a:hover, h6 > a:hover,
      h1 > a:focus, h2 > a:focus, h3 > a:focus, h4 > a:focus, h5 > a:focus, h6 > a:focus {
        text-decoration: underline;
        color: #1fad3e;
      }
      ul, ol {
        margin-top: 0;
      }
      .post-body h1 {
        font-family: Open sans;
      }
      h2 {
        padding-bottom: 16px;
        font-size: 32px;
        margin: 0;
        margin-top: 1em;
      }
      p {
        margin: 0;
        padding-bottom: 1em;
      }
      blockquote > p:last-child {
        padding-bottom: 0;
      }
      h3 {
        margin-bottom: 8px;
        font-family: Open sans;
        font-weight: normal;
        margin-top: 8px;
        color: #6e6e6e;
        font-size: 30px;
      }
      h5 {
        font-family: open sans;
        margin: 0;
        margin-top: 16px;
      }
      /* a:visited {
        color: #333;
      } */
      
</style>
<style>
.style-562977262 {
  max-width: 700px;
}
@media(max-width: 1060px) {
.style-562977262 {
  flex-shrink: 1;
  min-width: 0;
}
}
.style-362825327 {
  display: block;
  width: 160px;
  height: 160px;
}
.style-105406039 {
  font-size: 24px;
  line-height: 36px;
  hyphens: auto;
}
@media(max-width: 600px) {
.style-105406039 {
  font-size: 20px;
  line-height: 30px;
}
}
.style-378508498 {
  color: #999;
  font-family: Open sans;
  font-size: 14px;
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: flex-start;
}
.style-254026428 {
  font-family: Open sans, sans-serif;
  font-size: 20px;
}
.style-254026428 a {
  text-decoration: none;
}
.style-254026428 a:hover {
  text-decoration: underline;
}
.style-231757563 {
  font-family: Linux Libertine;
  color: #333;
  margin: 0;
  padding: 0;
}
.style-665563595 {
  flex-shrink: 1;
  overflow: auto;
}
.style-723831218 {
  font-size: 24px;
  line-height: 36px;
  flex: 1;
  display: flex;
  flex-direction: column;
  flex-wrap: nowrap;
  text-align: left;
}
.style-679839639 {
  background-color: #fff4ef;
  max-width: 400px;
  flex-shrink: 1;
  min-width: 300px;
  padding: 40px;
}
@media(max-width: 835px) {
.style-679839639 {
  padding: 16px;
}
}
@media(max-width: 1650px) {
.style-679839639 {
  padding: 20px;
}
}
@media(max-width: 1060px) {
.style-679839639 {
  display: none;
}
}
.style-74395582 {
  color: #999;
  display: flex;
  flex-direction: row;
}
.style-129913994 {

}
.style-507597651 {
  text-decoration: none;
}
.style-627275581 {
  margin-top: 100px;
  font-size: 56px;
  margin-bottom: 16px;
  padding-top: 32px;
}
@media(max-width: 600px) {
.style-627275581 {
  font-size: 32px;
  margin-top: 40px;
}
}
@media(max-width: 600px) {
.style-627275581 {
  margin-top: 40px;
}
}
.style-817623655 {
  padding: 0 16px;
  flex-shrink: 1;
  overflow: auto;
}
.style-760303782 {
  margin-bottom: 40px;
  justify-content: center;
  display: flex;
  flex-direction: row;
}
.style-760303782 a {
  margin: 0 8px;
}
.style-179062008 {
  flex-direction: row;
  padding: 0 20px;
  display: flex;
  justify-content: center;
  align-items: stretch;
  flex-wrap: wrap;
  justify-content: flex-start;
  flex-wrap: nowrap;
}
@media(max-width: 1060px) {
.style-179062008 {
  justify-content: center;
}
}
@media(max-width: 835px) {
.style-179062008 {
  padding: 8px;
}
}
.style-504547095 {
  margin: 0 auto;
  width: 160px;
  overflow: hidden;
  height: 160px;
  display: block;
  border-radius: 50%;
  border: 5px solid white;
  background-color: white;
  box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3);
}
.style-310129452 {
  text-align: center;
  font-size: 36px;
}
.style-580730263 {
  top: 40px;
}
@media(max-width: 835px) {
.style-580730263 {
  top: 16px;
}
}
@media(max-width: 1650px) {
.style-580730263 {
  top: 20px;
}
}
@media(min-width: 835px) {
.style-580730263 {
  position: sticky;
  height: calc(100vh - 40px);
  display: flex;
  flex-wrap: nowrap;
  flex-direction: column;
}
}
.style-466863072 {

}
@media(max-width: 1060px) {
.style-466863072 {
  display: none;
}
}
.style-245007015 {
  font-size: 16px;
  margin-bottom: 16px;
  display: block;
  line-height: 20px;
  color: currentColor;
  text-decoration: none;
}
.style-245007015:hover {
  text-decoration: underline;
}
</style>
</head>
<body class="style-231757563" lang="en">
<div class="style-179062008">
<div class="style-679839639">
<div class="style-580730263">
<a href="/" class="style-504547095"><img src="https://www.gravatar.com/avatar/313878fc8f316fc3fe4443b13913d0a4.png?s=200" alt="Jared Forsyth" class="style-362825327"/></a>
<div style="height: 40px"></div>
<div class="style-310129452">I'm Jared Forsyth</div>
<div style="height: 40px"></div>
<div class="style-723831218">
<div class="style-760303782">
<a href="/">home</a>
<a href="/posts/">posts</a>
<a href="/projects/">projects</a>
<a href="/talks/">talks</a>
</div>
<div class="style-817623655">
<div class="style-129913994">Recent posts</div>
<div style="height: 8px"></div>
<a href="/posts/hybrid-logical-clocks/" class="style-245007015">
<div>Hybrid Logical Clocks</div>
<div class="style-74395582">
2020
February
14
</div>
</a>
<a href="/posts/my-scientific-sourdough/" class="style-245007015">
<div>My Scientific Sourdough üçû</div>
<div class="style-74395582">
2019
December
31
</div>
</a>
<a href="/posts/announcing-milk/" class="style-245007015">
<div>Automatic, well-typed JSON serialization in Reason/OCaml with Milk ü•õ</div>
<div class="style-74395582">
2019
May
28
</div>
</a>
<a href="/posts/intoducing-terraform/" class="style-245007015">
<div>Terraform: generate 3-d models of geographic terrain</div>
<div class="style-74395582">
2019
May
16
</div>
</a>
<a href="/posts/optional-attribute-access-in-reason/" class="style-245007015">
<div>Optional Attribute Access in Reason</div>
<div class="style-74395582">
2018
November
13
</div>
</a>























<div style="height: 32px"></div>
</div>
<div class="style-254026428" style="text-align:center">
<a href="https://twitter.com/jaredforsyth">twitter/@jaredforsyth</a>
<br/>
<a href="https://github.com/jaredly">github/@jaredly</a>
</div>
</div>
</div>
</div>
<div class="style-466863072" style="flex-basis: 100px; flex-shrink: 1"></div>
<div class="style-562977262">
<main role="main">
<article>
<h1 class="style-627275581">Local-first database: gun.js</h1>
<div class="style-378508498">
January
<div style="flex-basis: 4px"></div>
14,
<div style="flex-basis: 4px"></div>
2020
<div style="flex-basis: 8px"></div>
 ¬∑ 
<div style="flex-basis: 8px"></div>
<a href="/tags/local-first/" class="style-507597651">local-first</a>
<div style="flex-basis: 8px"></div>
<span style="background-color: red; padding: 4px 8px; display: inline-block; color: white; border-radius: 4px">draft</span>
</div>
<div style="height: 32px"></div>
<div class="post-body style-105406039">
<p><a href="">gun.js</a> is an open-source project I&#39;ve had my eye on for several years, now, every once in a while checking back to see how it&#39;s progressed, and whether the project I&#39;m working on at the time is a good fit for it.</p>

<p>Gun bills itself as decentralized, offline-first, and privacy focused.</p>

<div class='note'><p>I had a fair bit of trouble following the source code üòÖ so I had to skip some of the &quot;eyes-based&quot; analysis of their algorithms. However, there are some nice docs about the <a href="https://github.com/amark/gun/wiki/Conflict-Resolution-with-Guns" target="_blank">CRDT implementation</a>.</p>
</div>
<p>Using my <a href="">criteria for a local-first database</a>, here&#39;s how it stacks up:</p>

<h1 id="Correctness"><a href="#Correctness">Correctness</a></h1>

<ul><li><div><p>How are conflicts handled?</p>

<p>Looks like they&#39;ve got a CRDT setup where they denormalize any nested data structures, so conflicts will be handled correctly.</p>
</div></li>
<li><div><p>Is there consistency verification built-in, to detect if you&#39;re in a boken state?</p>

<p>I couldn&#39;t see anything in the docs about this, so maybe?</p>
</div></li>
<li><div><p>How well does sync preserve intent?</p>

<p>From their <a href="https://github.com/amark/gun/wiki/Conflict-Resolution-with-Guns" target="_blank">CRDT docs</a> it looks like they use a hybrid logical clock, so intent should be preserved pretty well.</p>
</div></li></ul>
<h1 id="Cost"><a href="#Cost">Cost</a></h1>
<p>Storage</p>

<ul><li><div><p>How much data does the client need to store to fully replicate?</p>

<p>O(size of the data), with K ~= 3.1</p>
</div></li>
<li><div><p>How much data does the server need to store?</p>

<p>O(size of the data), K ~= 3.7</p>
</div></li>
<li><div><p>How complicated is the server logic?</p>

<p>It appears there&#39;s a fair amount of communication back &amp; forth, negotiating what nodes need to be replicated.</p>
</div></li></ul>
<p>Network transfer</p>

<ul><li><div><p>Adding data:</p>

<p>client -&gt; server is O(size of data), K ~= 8.5</p>

<p>server -&gt; client is O(size of data), K ~= 7.5</p>
</div></li>
<li><div><p>Cold start:</p>

<p>server -&gt; client is ~8.3x size of data</p>

<p>client -&gt; server is ~0.5x size of data</p>
</div></li>
<li><div><p>Modifying an attribute:</p>

<p>client -&gt; server O(messages) K ~= 2.3</p>

<p>server -&gt; lcient O(messages) K ~= 0.7</p>
</div></li></ul>
<p>Code / implementation</p>

<ul><li><div><p>tests: <code>npm test</code> runs 130 tests, with 12 failing on master</p>
</div></li>
<li><div><p>coverage: not reported</p>
</div></li>
<li><div><p>community: 4 committers in the past month, pretty active discord server.</p>
</div></li></ul>
<h1 id="Flexibility"><a href="#Flexibility">Flexibility</a></h1>

<ul><li><div><p>How does it react to schema changes?</p>

<p>Looks like it puts no restrictions on schema changes.</p>
</div></li>
<li><div><p>is the shape of data restricted to anything less than full JSON?</p>

<p>Yes, no nested arrays. Additionally, GUN enforces denormalization, so when you retrieve an object that has &quot;nested&quot; objects inside of it, you need to make another async call to fetch the nested object.</p>
</div></li>
<li><div><p>Can it be used with an existing database?</p>

<p>While you might potentially be able to create a backend that uses leveldb or some key-value store, it doesn&#39;t look like anyone has tried, and I doubt that you could use a relational database as the backend.</p>
</div></li>
<li><div><p>Can it sync with Google Drive, Dropbox, etc.?</p>

<p>Not natively, it requires an active server.</p>
</div></li>
<li><div><p>Does it require all data to live in memory, or can it work with mostly-persisted data?</p>

<p>Hard to tell, but it looks like currently all data lives in memory.</p>
</div></li>
<li><div><p>Does it support e2e encryption?</p>

<p>Yes! When you are logged in (which involves decrypting a pub/priv keypair from the replicated graph), all data that you add under your user is encrypted.</p>
</div></li>
<li><div><p>Does it bake in auth, or can you use an existing authentication setup?</p>

<p>Auth is included, and you cannot use an existing authentication setup. Some interesting aspects of the authentication system is that usernames are not guarenteed to be unique, and there is no recourse for lost passwords.</p>
</div></li>
<li><div><p>Is multi-user collaboration possible, where some users only have access to a subset of the data?</p>

<p>Theoretically? I haven&#39;t found anything in the docs detailing how this would work.</p>
</div></li>
<li><div><p>Is collaborative text editing possible?</p>

<p><a href="https://www.youtube.com/watch?v=rci89p0o2wQ&feature=youtu.be" target="_blank">Theoretically</a>?</p>
</div></li>
<li><div><p>Does it have the concept of &quot;undo&quot; built-in?</p>

<p>No.</p>
</div></li>
<li><div><p>Does it support a fully p2p network setup?</p>

<p>Yes, that&#39;s what it&#39;s designed for.</p>
</div></li></ul>

<h1 id="Benchmark-analysis"><a href="#Benchmark-analysis">Benchmark analysis</a></h1>
<div class='note'><p>My setup for benchmarking is to use <a href="https://github.com/jaredly/prayer/tree/574e3d6ce9469c5325d829c00bfac118992d75f4" target="_blank">this repo</a>, running <code>backends/gunjs/index.js</code>, <code>backends/gunjs/proxy.js</code> and <code>yarn parcel html/index.html</code>, then navigating to the <code>gun.js</code> demo on that page.</p>
</div>
<p>Blank Startup</p>

<ul><li><div><p>{ toServer: 288, fromServer: 222 }</p>
</div></li>
<li><div><p>then heartbeat every once in a while, 2 bytes</p>
</div></li></ul>
<p>Adding 100</p>

<ul><li><div><p>time (parallel): 0.68s</p>
</div></li>
<li><div><p>min length: 11761</p>
</div></li>
<li><div><p>localstorage length: 36454 -&gt; 3.07x</p>
</div></li>
<li><div><p>server: 48k -&gt; 4.17x</p>
</div></li>
<li><div><p>{ toServer: 101654 (8.6x), fromServer: 87912 (7.5x) }</p>
</div></li></ul>
<p>Adding the second 100 types:</p>

<ul><li><div><p>time: 0.7s</p>
</div></li>
<li><div><p>min length: 23721</p>
</div></li>
<li><div><p>localstorage length: 72994 -&gt; 3.07x</p>
</div></li>
<li><div><p>server: 88k -&gt; 3.9x</p>
</div></li>
<li><div><p>{ toServer: 203203 (8.5x), fromServer: 175346 (7.4x) }</p>
</div></li></ul>
<p>Adding the third 100 types:</p>

<ul><li><div><p>time: 0.8s</p>
</div></li>
<li><div><p>min length: 35681</p>
</div></li>
<li><div><p>localstorage length: 109466 -&gt; 3.06x</p>
</div></li>
<li><div><p>server: 128k -&gt; 3.7x</p>
</div></li>
<li><div><p>{ toServer: 304612 (8.3x), fromServer: 262616 (7.4x) }</p>
</div></li></ul>
<p>Blank w/ 300 items in server</p>

<ul><li><div><p>before restart { toServer: 308684, fromServer: 264976 }</p>
</div></li>
<li><div><p>after restart { toServer: 20586 (0.6x min), fromServer: 299455 (8.3x min, 2.4x server data size) }</p>
</div></li>
<li><div><p>server size 126301</p>
</div></li>
<li><div><p>localstorage 111425 (3.1x min)</p>
</div></li></ul>
<p>Startup after having added 300 things</p>

<ul><li><div><p>theoretical minimum: like 10 bytes? (if you&#39;re using a merkle trie or something)</p>
</div></li>
<li><div><p>{ toServer: 19906 (0.5x total data), fromServer: 173402 (4.9x total data) }</p>
</div></li></ul>
<p>After adding another 300 things, startup:</p>

<ul><li><div><p>{ toServer: 39580 (0.5x total data) , fromServer: 295679 (4.15x total data) }</p>
</div></li></ul>
<p>Mutating a title 100 times (series)</p>

<ul><li><div><p>at start, localstorage: 111279</p>
</div></li>
<li><div><p>at start, messages: { toServer: 308394, fromServer: 264427 }</p>
</div></li>
<li><div><p>at start, server: 126137</p>
</div></li>
<li><div><p>In series: 42s</p>

<p>hmm parallel doesn&#39;t help too much, raises a lot of errors about &quot;no ack received yet&quot;</p>

<p>in series while offline is a little better, 9.1s</p>
</div></li>
<li><div><p>end, messages: { toServer: 324914 - 2.3x min, fromServer: 269414 - 0.7x min }</p>
</div></li>
<li><div><p>end, server: 126326</p>
</div></li>
<li><div><p>end, localstorage: 111466</p>
</div></li>
<li><div><p>a hypothetical &quot;lower bound-ish&quot; for stringified messages: 7191</p>
</div></li></ul>

</div>
</article>
</main>
<div style="height: 128px"></div>
</div>
<div class="style-466863072" style="flex-basis: 100px; flex-shrink: 1"></div>
</div>
</body>
</html>